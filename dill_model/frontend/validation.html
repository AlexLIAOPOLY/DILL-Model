<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="validation_title">结果验证 - 多模型光刻胶计算工具</title>
    <!-- 引入Google字体 -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- 引入Font Awesome图标库 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- 备用Font Awesome CDN -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.5.1/css/all.css" crossorigin="anonymous" />
    <!-- 引入样式文件 -->
    <link rel="stylesheet" href="css/style.css?v=1.2">
    <link rel="stylesheet" href="css/animations.css?v=1.1">
    <link rel="stylesheet" href="css/professional-header-footer.css?v=1.1">
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <!-- Chart.js for training curves -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .validation-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 25px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            transition: all 0.3s ease;
        }

        .section:hover {
            border-color: #ccc;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .section-title {
            font-size: 1.4em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2c3e50;
        }
        
        .parameter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .parameter-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            transition: all 0.2s ease;
        }
        
        .parameter-item:hover {
            background: #e9ecef;
        }
        
        .parameter-name {
            font-weight: 500;
            color: #495057;
        }
        
        .parameter-value {
            color: #007bff !important;
            font-family: monospace;
            font-weight: bold !important;
            font-size: 1.1em !important;
            min-width: 80px;
            text-align: right;
        }
        
        .parameter-category-title {
            grid-column: 1 / -1;
            margin: 20px 0 15px 0;
            border-radius: 4px;
            background: #f5f5f5;
            padding: 0 15px;
            border: 1px solid #ddd;
        }
        
        .parameter-category-title:first-child {
            margin-top: 0;
        }
        
        .parameter-category-title h3 {
            color: #333 !important;
            font-size: 1.2em !important;
            margin: 0 !important;
            padding: 15px 0 !important;
            border-bottom: 1px solid #ccc !important;
            font-weight: 600 !important;
        }
        
        .thickness-plot-container {
            margin-top: 0;
            background: #f9f9f9;
            border-radius: 6px;
            padding: 15px;
            border: 1px solid #ddd;
            overflow: visible;
            width: 100%;
            height: auto;
        }
        
        #thickness-plot {
            width: 100%;
            height: 750px;
            overflow: visible;
            position: relative;
            margin: 0 auto;
            box-sizing: border-box;
            display: block;
        }
        
        /* 清除所有可能的尺寸限制 */
        #thickness-plot > div {
            width: 100% !important;
            height: 100% !important;
        }
        
        #thickness-plot .plotly-graph-div {
            width: 100% !important;
            height: 100% !important;
        }
        
        #thickness-plot .svg-container {
            width: 100% !important;
            height: 100% !important;
        }
        
        #thickness-plot .main-svg {
            width: 100% !important;
            height: 100% !important;
        }
        
        .annotation-controls {
            margin-top: 25px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 15px;
            border-top: 1px solid #ddd;
            background: #f5f5f5;
            border-radius: 4px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #0056b3;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: #545b62;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            background: #1e7e34;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* 验证数据选择器样式 */
        .validation-selector-container {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .selector-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .selector-header h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .selector-header p {
            color: #6c757d;
            font-size: 14px;
            margin: 0;
        }

        .target-settings {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }

        .custom-settings {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }

        .custom-settings h5 {
            color: #495057;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .setting-row select {
            flex: 1;
            max-width: 200px;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }

        .setting-row {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
        }

        .setting-row:last-child {
            margin-bottom: 0;
        }

        .setting-row label {
            min-width: 120px;
            font-weight: 500;
            color: #495057;
        }

        .setting-row input {
            flex: 1;
            max-width: 150px;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
        }

        .validation-records-list {
            background: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            margin-bottom: 20px;
        }

        .records-header {
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            background: #f8f9fa;
        }

        .record-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .selected-count {
            margin-left: auto;
            font-weight: 500;
            color: #007bff;
        }

        .records-container {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
        }

        .validation-record {
            display: flex;
            align-items: flex-start;
            padding: 15px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.2s ease;
            cursor: pointer;
            background: white;
            position: relative;
            gap: 12px;
        }

        .validation-record:hover {
            background: #f8f9fa;
            border-color: #007bff;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.1);
        }

        .validation-record.selected {
            background: #e3f2fd;
            border-color: #007bff;
            box-shadow: 0 2px 4px rgba(0, 123, 255, 0.2);
        }

        .validation-record.dragging {
            opacity: 0.5;
            transform: rotate(3deg);
            z-index: 1000;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .record-drag-handle {
            color: #6c757d;
            cursor: grab;
            font-weight: bold;
            font-size: 16px;
            padding: 5px;
            -webkit-user-select: none;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            opacity: 0.6;
            transition: all 0.2s ease;
        }

        .record-drag-handle:hover {
            color: #007bff;
            opacity: 1;
        }

        .record-drag-handle:active {
            cursor: grabbing;
        }

        .record-placeholder {
            border: 2px dashed #007bff;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 10px;
            background: #f8f9ff;
            text-align: center;
            color: #007bff;
            opacity: 0.7;
            animation: pulse 1.5s infinite;
        }

        .placeholder-text {
            font-style: italic;
            font-size: 14px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        .record-checkbox {
            margin-right: 12px;
        }

        .record-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .record-timestamp {
            font-size: 12px;
            color: #6c757d;
            background: #f8f9fa;
            padding: 2px 8px;
            border-radius: 4px;
            font-family: monospace;
        }

        .record-values {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }

        .record-deviation-visual {
            margin: 10px 0;
        }

        .deviation-bar-container {
            position: relative;
            height: 24px;
            background: #f8f9fa;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #e9ecef;
        }

        .deviation-bar-container::before {
            content: "需减少曝光";
            position: absolute;
            left: 5px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 9px;
            color: #6c757d;
            z-index: 0;
        }

        .deviation-bar-container::after {
            content: "需增加曝光";
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 9px;
            color: #6c757d;
            z-index: 0;
        }

        .deviation-center-line {
            position: absolute;
            left: 50%;
            top: 0;
            width: 2px;
            height: 100%;
            background: #6c757d;
            transform: translateX(-50%);
            z-index: 1;
        }

        .deviation-bar {
            position: absolute;
            top: 50%;
            height: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 500;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            z-index: 2;
        }

        .deviation-bar.deviation-accurate {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .deviation-bar.deviation-slightly-under {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
        }

        .deviation-bar.deviation-under {
            background: linear-gradient(135deg, #fd7e14, #dc3545);
        }

        .deviation-bar.deviation-slightly-over {
            background: linear-gradient(135deg, #17a2b8, #007bff);
        }

        .deviation-bar.deviation-over {
            background: linear-gradient(135deg, #007bff, #6f42c1);
        }

        .deviation-bar.deviation-neutral {
            background: linear-gradient(135deg, #6c757d, #495057);
        }

        .deviation-text {
            white-space: nowrap;
            font-size: 10px;
            font-weight: 600;
        }

        .record-position {
            font-weight: 500;
            color: #495057;
        }

        .record-values {
            display: flex;
            flex-direction: column;
            font-size: 13px;
        }

        .record-simulated {
            color: #6c757d;
        }

        .record-actual {
            color: #28a745;
            font-weight: 500;
        }

        .record-deviation {
            font-weight: 500;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
        }

        .record-deviation.positive {
            background: #fff3cd;
            color: #856404;
        }

        .record-deviation.negative {
            background: #f8d7da;
            color: #721c24;
        }

        .record-deviation.neutral {
            background: #d1ecf1;
            color: #0c5460;
        }

        .record-analysis {
            font-size: 12px;
            color: #6c757d;
            text-align: right;
        }

        .optimization-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .loading-message {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }

        /* 分析结果样式（已停用显示） */
        .analysis-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #e9ecef;
            display: none !important;
        }
        
        /* 结果说明样式 */
        .result-hint {
            font-size: 12px;
            color: #6c757d;
            margin-top: 6px;
            margin-bottom: 0;
            line-height: 1.4;
            font-style: italic;
            display: block;
            clear: both;
            flex-basis: 100%;      /* 强制换行到下一行 */
            width: 100%;           /* 占满一行 */
            text-align: left;      /* 小字左对齐 */
        }
        
        /* 结果项布局调整 */
        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .result-item .result-label {
            flex: 0 0 auto;
        }
        
        .result-item .result-value {
            flex: 0 0 auto;
            text-align: right;
            margin-left: auto;
        }
        
        /* 多策略胶囊容器右对齐 */
        .exposure-time-list {
            margin-left: auto;
            text-align: right;
        }

        .analysis-header h5 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .analysis-content {
            display: grid;
            gap: 10px;
        }

        .analysis-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .analysis-item:last-child {
            border-bottom: none;
        }

        .analysis-label {
            font-weight: 500;
            color: #495057;
        }

        .analysis-value {
            color: #007bff;
            font-weight: 500;
        }
        
        .annotation-list {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .annotation-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            margin-bottom: 5px;
        }
        
        .annotation-coords {
            font-family: monospace;
            color: #6c757d;
        }
        
        .annotation-value {
            font-weight: 500;
            color: #007bff;
        }
        
        .delete-annotation {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .status-message {
            padding: 10px 15px;
            border-radius: 4px;
            margin-top: 15px;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .model-training-section {
            background: #f9f9f9;
            border: 1px solid #ddd;
        }
        
        .main-content {
            min-height: calc(100vh - 200px);
            padding-top: 20px;
            background: #f5f5f5;
        }

        /* 自定义标注弹窗样式 */
        .annotation-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { 
                opacity: 0;
                transform: translate(-50%, -60%);
            }
            to { 
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        .annotation-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 0;
            border-radius: 8px;
            border: 1px solid #ddd;
            width: 450px;
            max-width: 90vw;
            overflow: hidden;
        }

        .annotation-modal-header {
            background: #007bff;
            padding: 25px 30px;
            color: white;
            position: relative;
        }

        .annotation-modal-header h3 {
            margin: 0;
            font-size: 1.4em;
            font-weight: 600;
            display: flex;
            align-items: center;
        }

        .annotation-modal-header .close-btn {
            position: absolute;
            top: 50%;
            right: 25px;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .annotation-modal-header .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-50%) rotate(90deg);
        }

        .annotation-modal-body {
            padding: 30px;
        }

        .coordinate-info {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 25px;
            border: 1px solid #ddd;
        }

        .coordinate-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .coordinate-row:last-child {
            margin-bottom: 0;
        }

        .coordinate-label {
            font-weight: 600;
            color: #495057;
            font-size: 0.95em;
        }

        .coordinate-value {
            font-family: 'Monaco', 'Menlo', monospace;
            font-weight: bold;
            color: #20c997;
            background: white;
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid #20c997;
            font-size: 0.9em;
        }

        .input-group {
            margin-bottom: 25px;
        }

        .input-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
            font-size: 1em;
        }

        .measurement-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1.1em;
            font-family: 'Monaco', 'Menlo', monospace;
            font-weight: bold;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .measurement-input:focus {
            outline: none;
            border-color: #007bff;
            background: white;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: nowrap;
        }

        .modal-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
            min-width: 100px;
            justify-content: center;
        }

        .modal-btn-cancel {
            background: #6c757d;
            color: white;
        }

        .modal-btn-cancel:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .modal-btn-confirm {
            background: #28a745;
            color: white;
        }

        .modal-btn-confirm:hover {
            background: #1e7e34;
        }

        .modal-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        /* 手动标注弹窗 - 简洁美观风格（仅作用于该弹窗） */
        #manual-annotation-modal .annotation-modal-content {
            width: 520px;
            max-width: 92vw;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.12);
            overflow: hidden;
        }

        #manual-annotation-modal .annotation-modal-header {
            background: linear-gradient(180deg, #ffffff 0%, #edf7ff 100%);
            color: #0f172a;
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
        }

        #manual-annotation-modal .annotation-modal-header h3 {
            font-size: 18px;
            font-weight: 600;
        }

        #manual-annotation-modal .annotation-modal-header .close-btn {
            color: #64748b;
        }

        #manual-annotation-modal .annotation-modal-header .close-btn:hover {
            background: #f1f5f9;
            color: #0f172a;
        }

        #manual-annotation-modal .annotation-modal-body {
            padding: 20px 24px;
        }

        #manual-annotation-modal .coordinate-info {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
        }

        #manual-annotation-modal .coordinate-value {
            color: #0f172a;
            border-color: #94a3b8;
            background: #ffffff;
        }

        #manual-annotation-modal .measurement-input {
            background: #f8fafc;
            border-color: #e5e7eb;
        }

        #manual-annotation-modal .measurement-input:focus {
            border-color: #0ea5e9;
            background: #ffffff;
        }

        #manual-annotation-modal .modal-buttons {
            justify-content: flex-end;
            gap: 12px;
        }

        /* 按钮色系：避免使用紫色与图标，保持简洁 */
        .modal-btn-primary {
            background: #0ea5e9;
            color: #ffffff;
        }

        .modal-btn-primary:hover {
            background: #0284c7;
        }

        .modal-btn-success {
            background: #10b981;
            color: #ffffff;
        }

        .modal-btn-success:hover {
            background: #059669;
        }

        /* 数据点标注弹窗 - 简洁美观风格（仅作用于该弹窗） */
        #annotation-modal .annotation-modal-content {
            width: 520px;
            max-width: 92vw;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.12);
            overflow: hidden;
        }

        #annotation-modal .annotation-modal-header {
            background: linear-gradient(180deg, #ffffff 0%, #edf7ff 100%);
            color: #0f172a;
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
        }

        #annotation-modal .annotation-modal-header h3 {
            font-size: 18px;
            font-weight: 600;
        }

        #annotation-modal .annotation-modal-header .close-btn {
            color: #64748b;
        }

        #annotation-modal .annotation-modal-header .close-btn:hover {
            background: #f1f5f9;
            color: #0f172a;
        }

        #annotation-modal .annotation-modal-body {
            padding: 20px 24px;
        }

        #annotation-modal .coordinate-info {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 16px;
        }

        #annotation-modal .coordinate-value {
            color: #0f172a;
            border-color: #94a3b8;
            background: #ffffff;
        }

        #annotation-modal .measurement-input {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }

        #annotation-modal .measurement-input:focus {
            border-color: #0ea5e9;
            background: #ffffff;
        }

        #annotation-modal .modal-buttons {
            justify-content: flex-end;
            gap: 12px;
        }

        /* 训练参数设置弹窗 - 简洁美观风格（仅作用于该弹窗） */
        #training-settings-modal .annotation-modal-content {
            max-width: 92vw;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.12);
            overflow: hidden;
        }

        #training-settings-modal .annotation-modal-header {
            background: linear-gradient(180deg, #ffffff 0%, #edf7ff 100%);
            color: #0f172a;
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
        }

        #training-settings-modal .annotation-modal-header h3 {
            font-size: 18px;
            font-weight: 600;
        }

        #training-settings-modal .annotation-modal-header .close-btn {
            color: #64748b;
        }

        #training-settings-modal .annotation-modal-header .close-btn:hover {
            background: #f1f5f9;
            color: #0f172a;
        }

        #training-settings-modal .annotation-modal-body {
            padding: 20px 24px;
        }

        #training-settings-modal .measurement-input {
            background: #f8fafc;
            border-color: #e5e7eb;
        }

        #training-settings-modal .measurement-input:focus {
            border-color: #0ea5e9;
            background: #ffffff;
        }

        /* 让“模型类型”看起来是下拉框 */
        #training-settings-modal select.measurement-input {
            appearance: none;
            -moz-appearance: none;
            -webkit-appearance: none;
            padding-right: 36px;
            cursor: pointer;
            background-color: #f8fafc;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 20 20'%3E%3Cpath fill='%2364748b' d='M5.23 7.21a.75.75 0 011.06.02L10 10.17l3.71-2.94a.75.75 0 111.04 1.08l-4.24 3.36a.75.75 0 01-.94 0L5.21 8.31a.75.75 0 01.02-1.1z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 18px 18px;
        }

        #training-settings-modal .modal-buttons {
            justify-content: flex-end;
            gap: 12px;
        }



        /* 增强标注项样式 */
        .annotation-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
            flex-wrap: wrap;
            gap: 10px;
        }

        .annotation-item:hover {
            background: #f8f9fa;
        }

        .annotation-coords {
            font-family: 'Monaco', 'Menlo', monospace;
            color: #6c757d;
            font-weight: 600;
            min-width: 120px;
        }

        .annotation-value {
            font-weight: 600;
            color: #e74c3c;
        }

        .delete-annotation {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 12px;
        }

        .delete-annotation:hover {
            background: #c82333;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            
            .annotation-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .annotation-coords {
                min-width: auto;
            }
            
            .modal-buttons {
                flex-direction: column;
                gap: 8px;
            }
            
            .modal-btn {
                width: 100%;
                min-width: auto;
            }
        }

        /* Excel数据查看样式 */
        .excel-data-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px 20px;
            background: #f5f5f5;
            border-radius: 6px;
            border: 1px solid #ddd;
        }

        .excel-data-header h4 {
            margin: 0;
            color: #2c3e50;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .record-count-badge {
            background: #28a745;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
        }

        .btn-small {
            padding: 8px 16px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-small:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .excel-table-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            margin-top: 15px;
        }

        .excel-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        .excel-table th {
            background: #28a745;
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 1px solid #ddd;
            font-size: 13px;
        }

        .excel-table th:first-child {
            border-top-left-radius: 12px;
        }

        .excel-table th:last-child {
            border-top-right-radius: 12px;
        }

        .excel-table td {
            padding: 12px;
            border-bottom: 1px solid #f1f3f4;
            vertical-align: middle;
            transition: all 0.2s ease;
        }

        .excel-table tr {
            transition: all 0.3s ease;
        }

        .excel-table tr:hover {
            background: #f5f5f5;
        }

        .excel-table tr:nth-child(even) {
            background: #fdfdfd;
        }

        .excel-table tr:nth-child(even):hover {
            background: #f5f5f5;
        }

        .excel-table tr:last-child td:first-child {
            border-bottom-left-radius: 12px;
        }

        .excel-table tr:last-child td:last-child {
            border-bottom-right-radius: 12px;
        }

        .param-cell {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .param-cell:hover {
            white-space: normal;
            overflow: visible;
            background: #fff3cd;
            position: relative;
            z-index: 5;
        }

        .timestamp-cell {
            font-family: monospace;
            color: #6c757d;
            font-size: 0.85em;
        }

        .coord-cell {
            font-family: monospace;
            font-weight: 600;
            color: #495057;
        }

        .value-cell {
            font-family: monospace;
            font-weight: bold;
        }

        .simulated-value {
            color: #007bff;
        }

        .actual-value {
            color: #e74c3c;
        }

        .no-data-message {
            text-align: center;
            color: #6c757d;
            padding: 40px 20px;
            font-style: italic;
        }

        /* Excel控件美化样式 */
        .excel-controls {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: #f5f5f5;
            border-radius: 6px;
            border: 1px solid #ddd;
            align-items: center;
        }

        .search-group {
            grid-column: 1;
            min-width: 0;
            width: 100%;
        }

        .search-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            color: #6c757d;
            font-size: 14px;
            z-index: 2;
        }

        .search-input {
            width: 100%;
            padding: 10px 12px 10px 35px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            transition: all 0.3s ease;
            color: #495057;
        }

        .search-input:focus {
            outline: none;
            border-color: #007bff;
            background: #fff;
        }

        .search-input::placeholder {
            color: #adb5bd;
            font-style: italic;
        }

        .page-size-group {
            grid-column: 2;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            justify-self: end;
        }

        .control-label {
            font-size: 14px;
            font-weight: 500;
            color: #495057;
            white-space: nowrap;
        }

        .page-size-select {
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: white;
            font-size: 14px;
            font-weight: 500;
            color: #495057;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 80px;
        }

        .page-size-select:focus {
            outline: none;
            border-color: #007bff;
        }

        .page-size-select:hover {
            border-color: #20c997;
        }

        /* 分页控件美化样式 */
        .pagination-container {
            margin-top: 25px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 6px;
            border: 1px solid #ddd;
        }

        .pagination-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #dee2e6;
        }

        .record-info {
            font-size: 14px;
            font-weight: 600;
            color: #20c997;
            background: white;
            padding: 5px 12px;
            border-radius: 20px;
            border: 1px solid #20c997;
        }

        .page-info {
            font-size: 14px;
            color: #6c757d;
            font-weight: 500;
        }

        .pagination-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .page-btn {
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: white;
            color: #495057;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            min-width: 40px;
            justify-content: center;
        }

        .page-btn:hover {
            border-color: #007bff;
            background: #007bff;
            color: white;
        }

        .page-btn.active {
            background: #007bff;
            border-color: #007bff;
            color: white;
            font-weight: 600;
        }

        .page-btn-prev,
        .page-btn-next {
            padding: 8px 16px;
            font-weight: 600;
        }

        .page-number {
            min-width: 40px;
        }

        .page-dots {
            color: #6c757d;
            font-weight: bold;
            padding: 0 5px;
            display: flex;
            align-items: center;
        }

        /* 响应式布局调整 */
        @media (max-width: 768px) {
            .excel-controls {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .search-group {
                grid-column: 1;
            }
            
            .page-size-group {
                grid-column: 1;
                justify-self: center;
            }
        }

        @media (max-width: 992px) and (min-width: 769px) {
            .excel-controls {
                gap: 15px;
            }
        }

        /* 优化方法选择卡片样式 */
        .method-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .method-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .method-card:hover {
            border-color: #007bff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
        }

        .method-header {
            margin-bottom: 15px;
        }

        .method-header h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.3em;
            font-weight: 600;
        }

        .method-description {
            margin-bottom: 20px;
        }

        .method-description p {
            color: #6c757d;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .method-description ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .method-description li {
            color: #495057;
            padding: 4px 0;
            position: relative;
            padding-left: 20px;
            font-size: 0.9em;
        }

        .method-description li::before {
            content: '✓';
            position: absolute;
            left: 0;
            color: #28a745;
            font-weight: bold;
        }

        .method-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .method-actions .btn {
            flex: 1;
            min-width: 120px;
            justify-content: center;
        }

        /* 智能优化输入弹窗样式 */
        .optimization-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }

        .optimization-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 0;
            border-radius: 8px;
            border: 1px solid #ddd;
            width: 550px;
            max-width: 90vw;
            overflow: hidden;
        }

        .optimization-modal-header {
            background: #007bff;
            padding: 25px 30px;
            color: white;
            position: relative;
        }

        .optimization-modal-header h3 {
            margin: 0;
            font-size: 1.5em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-right: 50px; /* 给关闭按钮留出空间 */
        }

        .optimization-modal-header .close-btn {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .optimization-modal-header .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-50%) rotate(90deg);
        }

        .optimization-modal-body {
            padding: 30px;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .input-group-opt {
            margin-bottom: 20px;
        }

        .input-label-opt {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
            font-size: 0.95em;
        }

        .input-field-opt {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .input-field-opt:focus {
            outline: none;
            border-color: #007bff;
            background: white;
        }

        .optimization-results {
            margin-top: 25px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 6px;
            border: 1px solid #ddd;
            display: none;
        }

        .result-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .exposure-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .exposure-option {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .exposure-option:hover {
            border-color: #007bff;
        }

        .exposure-option.selected {
            border-color: #007bff;
            background: #e3f2fd;
        }

        .option-label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .option-value {
            font-family: monospace;
            font-size: 1.1em;
            font-weight: bold;
            color: #20c997;
        }

        .option-description {
            font-size: 0.85em;
            color: #6c757d;
            margin-top: 5px;
        }

        .modal-buttons-opt {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 25px;
        }




        /* 优化结果显示区域样式 */
        .result-display-area {
            margin-top: 20px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            animation: fadeInUp 0.3s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-header {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #007bff;
        }

        .result-header h4 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.2em;
            font-weight: 600;
        }

        .result-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-label {
            color: #6c757d;
            font-weight: 500;
            font-size: 14px;
        }

        .result-value {
            color: #007bff;
            font-weight: 600;
            font-size: 16px;
            font-family: monospace;
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .method-cards {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .input-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .exposure-options {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .method-actions {
                flex-direction: column;
            }
            
            .method-actions .btn {
                min-width: auto;
            }


            .result-announcement-content {
                width: 95%;
                margin: 20px;
            }

            .result-announcement-header {
                padding: 25px 20px;
            }

            .result-title {
                font-size: 20px;
            }

            .result-icon {
                font-size: 40px;
            }

            .result-announcement-body {
                padding: 20px;
            }

            .result-message {
                font-size: 16px;
            }

            .result-announcement-footer {
                padding: 15px 20px;
                flex-direction: column;
            }

            .result-btn {
                width: 100%;
                margin-bottom: 10px;
            }

            .result-btn:last-child {
                margin-bottom: 0;
            }
        }

        /* 折叠标题样式 */
        .collapsible-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 15px 20px;
            margin: 0 -20px 15px -20px;
            border-radius: 8px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid #dee2e6;
        }

        .collapsible-title:hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .collapsible-title .title-text {
            font-weight: 600;
            color: #2c3e50;
        }

        .collapse-icon {
            transition: transform 0.3s ease;
            color: #6c757d;
            font-size: 16px;
        }

        .collapsible-title.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            max-height: 1000px;
            opacity: 1;
        }

        .collapsible-content.collapsed {
            max-height: 0;
            opacity: 0;
            margin-bottom: 0;
        }

        .scrollable-container {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 6px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
        }

        .scrollable-container::-webkit-scrollbar {
            width: 8px;
        }

        .scrollable-container::-webkit-scrollbar-track {
            background: #f1f3f4;
            border-radius: 4px;
        }

        .scrollable-container::-webkit-scrollbar-thumb {
            background: #c1c8cd;
            border-radius: 4px;
            transition: background 0.3s ease;
        }

        .scrollable-container::-webkit-scrollbar-thumb:hover {
            background: #9da5ab;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
            justify-content: flex-end;
        }

        .action-buttons .btn {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            padding: 8px 16px;
        }

        .action-buttons .btn i {
            font-size: 12px;
        }
    </style>
</head>
<body data-page="validation">
    <!-- 页头 -->
    <header class="professional-header">
        <div class="header-main">
            <div class="header-content">
                <div class="brand-section">
                    <!-- 添加新的动态LOGO -->
                    <div class="dynamic-logo-container">
                        <div class="dynamic-logo">
                            <div class="dynamic-logo-circle"></div>
                            <div class="dynamic-logo-ring"></div>
                            <div class="dynamic-logo-orbit orbit-1">
                                <div class="dynamic-logo-particle particle-1"></div>
                            </div>
                            <div class="dynamic-logo-orbit orbit-2">
                                <div class="dynamic-logo-particle particle-2"></div>
                            </div>
                            <!-- 第三个轨道由CSS ::after伪元素创建 -->
                            <div class="dynamic-logo-particle particle-3"></div>
                        </div>
                    </div>
                    <div class="logo-container">
                        <div class="logo-text">
                            <div class="logo-title" data-i18n="logo_title">
                                <span class="logo-highlight">多模型</span>光刻胶计算平台
                            </div>
                            <div class="logo-subtitle" data-i18n="logo_subtitle">Multi-Model Photoresist Simulation Platform</div>
                        </div>
                    </div>
                </div>
                <nav class="main-nav">
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <a href="index.html" class="nav-link" data-i18n="nav_single">
                                <i class="fas fa-calculator"></i>
                                <span>单一计算</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="compare.html" class="nav-link" data-i18n="nav_compare">
                                <i class="fas fa-chart-line"></i>
                                <span>参数比较</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="../matrix_visualization/" class="nav-link" data-i18n="nav_matrix">
                                <i class="fas fa-cube"></i>
                                <span>模型矩阵可视化</span>
                            </a>
                        </li>
                        <li class="nav-item active">
                            <a href="validation.html" class="nav-link" data-i18n="nav_validation">
                                <i class="fas fa-check-circle"></i>
                                <span>结果验证</span>
                            </a>
                        </li>
                    </ul>
                </nav>
                <div class="header-utilities">
                    <div class="lang-switcher">
                        <select id="lang-select" class="lang-select" title="选择语言 / Select Language" aria-label="选择语言">
                            <option value="zh-CN">中文</option>
                            <option value="en">English</option>
                        </select>
                    </div>
                    <div class="github-link-container">
                        <a href="https://github.com/AlexLIAOPOLY/DILL-Model" target="_blank" rel="noopener" 
                           class="github-link" title="访问GitHub仓库" aria-label="访问GitHub仓库">
                            <i class="fab fa-github" aria-hidden="true"></i>
                            <svg aria-hidden="true" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" focusable="false" style="margin-left:-20px;">
                                <path d="M12 0.5C5.73 0.5 0.8 5.43 0.8 11.7c0 4.88 3.16 9.02 7.54 10.48.55.1.75-.24.75-.53 0-.26-.01-.94-.01-1.85-3.07.67-3.72-1.48-3.72-1.48-.5-1.27-1.22-1.61-1.22-1.61-.99-.68.08-.67.08-.67 1.09.08 1.66 1.12 1.66 1.12.97 1.66 2.55 1.18 3.17.9.1-.7.38-1.18.69-1.45-2.45-.28-5.02-1.23-5.02-5.48 0-1.21.43-2.19 1.12-2.96-.11-.28-.48-1.41.11-2.94 0 0 .92-.29 3.02 1.13.87-.24 1.8-.36 2.73-.36s1.86.12 2.73.36c2.1-1.42 3.02-1.13 3.02-1.13.59 1.53.22 2.66.11 2.94.69.77 1.12 1.75 1.12 2.96 0 4.26-2.58 5.2-5.04 5.48.39.33.73.98.73 1.98 0 1.43-.01 2.58-.01 2.94 0 .29.2.64.76.53 4.37-1.46 7.53-5.6 7.53-10.48C23.2 5.43 18.27 0.5 12 0.5z"/>
                            </svg>
                            <span class="github-tooltip">GitHub</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- 主要内容区域 -->
    <main class="main-content">
        <div class="validation-container">
            <!-- 参数显示区域 -->
            <div class="section">
                <h2 class="section-title collapsible-title collapsed" id="parameters-section-title">
                    <span class="title-text">计算参数配置</span>
                    <i class="fas fa-chevron-right collapse-icon" id="parameters-collapse-icon"></i>
                </h2>
                <div class="collapsible-content collapsed" id="parameters-content">
                    <div id="no-parameters-message" class="status-info">
                        请先在"单一计算"页面完成计算，然后返回此页面查看参数配置。
                    </div>
                    <div id="parameters-container" style="display: none;">
                        <div class="scrollable-container">
                            <div class="parameter-grid" id="parameters-grid">
                                <!-- 参数将通过JavaScript动态填充 -->
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button id="refresh-parameters" class="btn btn-secondary">
                                <i class="fas fa-sync-alt"></i> 刷新参数
                            </button>
                            <button id="edit-parameters" class="btn btn-primary">
                                <i class="fas fa-edit"></i> 修改参数
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 厚度图显示和标注区域 -->
            <div class="section">
                <h2 class="section-title">
                    光刻胶厚度图标注
                </h2>
                <div class="thickness-plot-container">
                    <div id="thickness-plot">
                        <!-- Plotly图表将在这里显示 -->
                    </div>
                    <div class="annotation-controls">
                        <button id="start-annotation" class="btn btn-primary">
                            开始标注
                        </button>
                        <button id="manual-annotation" class="btn btn-success">
                            手动添加
                        </button>
                        <button id="clear-annotations" class="btn btn-secondary">
                            清除标注
                        </button>
                        <span id="annotation-mode-indicator" style="margin-left: 15px; color: #6c757d; display: none;">
                            点击图表上的任意位置进行标注
                        </span>
                    </div>
                    <div class="annotation-list" id="annotation-list">
                        <!-- 标注列表将动态填充 -->
                    </div>
                </div>
            </div>

            <!-- 数据提交区域 -->
            <div class="section">
                <h2 class="section-title">
                    数据记录与提交
                </h2>
                <p>完成标注后，点击下方按钮将数据保存到Excel文件中，用于后续的模型训练。</p>
                <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button id="submit-data" class="btn btn-success" disabled>
                        保存验证数据
                    </button>
                    <button id="view-excel-data" class="btn btn-primary">
                        查看当前记录
                    </button>
                </div>
                
                <!-- Excel数据显示区域 -->
                <div id="excel-data-container" style="display: none; margin-top: 20px;">
                    <div class="excel-data-header">
                        <h4>当前Excel记录 <span id="record-count-badge" class="record-count-badge">0条记录</span></h4>
                        <button id="refresh-excel-data" class="btn-small">刷新</button>
                    </div>
                    <div id="excel-data-table" class="excel-table-container">
                        <!-- 表格数据将动态加载 -->
                    </div>
                </div>
            </div>

            <!-- 智能参数优化区域 -->
            <div class="section model-training-section">
                <h2 class="section-title">
                    智能参数优化系统
                </h2>
                <p>选择参数优化方式：使用机器学习模型（需要训练数据）或智能算法（基于物理模型）来优化参数。</p>
                
                <!-- 优化方式选择 -->
                <div class="optimization-method-selection" style="margin: 20px 0;">
                    <div class="method-cards">
                        <div class="method-card" id="ml-method-card">
                            <div class="method-header">
                                <h3>机器学习优化</h3>
                            </div>
                            <div class="method-description">
                                <p>基于验证数据训练模型，可预测所有参数的最优值</p>
                                <ul>
                                    <li>需要至少5条验证数据</li>
                                    <li>可优化所有光刻胶参数</li>
                                    <li>准确度随数据量增加而提升</li>
                                </ul>
                            </div>
                            <div class="method-actions">
                                <button id="show-training-settings" class="btn btn-primary">
训练设置
                                </button>
                                <button id="predict-parameters" class="btn btn-success">
参数预测
                                </button>
                            </div>
                        </div>
                        
                        <div class="method-card" id="algorithm-method-card">
                            <div class="method-header">
                                <h3>智能算法优化</h3>
                            </div>
                            <div class="method-description">
                                <p>基于验证数据的经验优化，选择参考记录进行智能调整</p>
                                <ul>
                                    <li>手动选择参考验证记录</li>
                                    <li>基于实际偏差进行优化</li>
                                    <li>经验驱动的曝光时间调整</li>
                                </ul>
                            </div>
                            <div class="method-actions">
                                <button id="show-validation-selector" class="btn btn-primary">
选择验证数据
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 验证数据选择器 -->
                <div id="validation-data-selector" class="validation-selector-container" style="display: none;">
                    <div class="selector-header">
                        <h4>选择参考验证记录</h4>
                        <p>选择要用于优化参考的验证数据记录，系统将基于这些记录的模拟-实际偏差进行智能调整</p>
                    </div>
                    
                    <!-- 目标参数设置 -->
                    <div class="target-settings">
                        <div class="setting-row">
                            <label for="target-thickness-input">目标厚度 (μm):</label>
                            <input type="number" id="target-thickness-input" step="0.1" value="1.0" min="0.1" max="5.0">
                        </div>
                        <div class="setting-row">
                            <label for="target-position-x">目标位置 X:</label>
                            <input type="number" id="target-position-x" step="1" value="0">
                        </div>
                        <div class="setting-row y-coord-field" id="target-position-y-row">
                            <label for="target-position-y">目标位置 Y:</label>
                            <input type="number" id="target-position-y" step="0.1" value="0">
                        </div>
                    </div>
                    
                    <!-- 自定义优化参数设置（已移动到验证记录列表下方显示） -->
                    
                    <!-- 验证记录列表 -->
                    <div class="validation-records-list">
                        <div class="records-header">
                            <div class="record-controls">
                                <button id="select-all-records" class="btn btn-secondary btn-small">全选</button>
                                <button id="clear-all-records" class="btn btn-secondary btn-small">清空</button>
                                <span class="selected-count">已选择: <span id="selected-records-count">0</span> 条</span>
                            </div>
                        </div>
                        <div id="validation-records-container" class="records-container">
                            <div class="loading-message">正在加载验证数据...</div>
                        </div>
                    </div>
                    
                    <!-- 自定义优化参数设置：放在验证记录列表下方 -->
                    <div id="custom-optimization-settings" class="custom-settings" style="display: none;">
                        <h5>自定义优化参数</h5>
                        <div class="setting-row">
                            <label for="custom-sensitivity">算法敏感度:</label>
                            <select id="custom-sensitivity">
                                <option value="1.0">低敏感度 (保守)</option>
                                <option value="2.0" selected>标准敏感度 (推荐)</option>
                                <option value="3.0">高敏感度 (激进)</option>
                            </select>
                            <div class="param-hint">控制优化调整的幅度。数值越高越激进，收敛更快但波动可能更大；数值越低越保守，更平稳但调整较小。</div>
                        </div>
                        <div class="setting-row">
                            <label for="custom-confidence-threshold">最低置信度:</label>
                            <select id="custom-confidence-threshold">
                                <option value="0.3">低要求 (30%)</option>
                                <option value="0.5" selected>中等要求 (50%)</option>
                                <option value="0.7">高要求 (70%)</option>
                            </select>
                            <div class="param-hint">用于过滤低可信的候选策略。阈值越高越严格，保留的策略更少但更可靠；阈值越低更宽松，策略更多样。</div>
                        </div>
                        <div class="setting-row">
                            <label for="custom-strategy-count">生成策略数量:</label>
                            <select id="custom-strategy-count">
                                <option value="1">单一最优策略</option>
                                <option value="3" selected>三种策略对比</option>
                                <option value="5">五种策略全面分析</option>
                            </select>
                            <div class="param-hint">返回用于对比的候选方案数量。更多方案便于比较，但生成与选择时间会略有增加。</div>
                        </div>
                    </div>
                    
                    <!-- 优化按钮 -->
                    <div class="optimization-buttons">
                        <button id="quick-optimize-btn" class="btn btn-primary" disabled>
                            快捷优化 (保守策略)
                        </button>
                        <button id="custom-optimize-btn" class="btn btn-success" disabled>
                            自定义优化 (多种策略)
                        </button>
                        <button id="cancel-optimization" class="btn btn-secondary">
                            取消
                        </button>
                    </div>
                </div>

                <!-- 优化结果显示区域 -->
                <div id="optimization-result-section" class="result-display-area" style="display: none;">
                    <div class="result-header">
                        <h4 id="result-title">基于验证数据的优化结果</h4>
                    </div>
                    <div class="result-content">
                        <div class="result-item">
                            <span class="result-label">推荐曝光时间：</span>
                            <span class="result-value" id="exposure-time-value">--</span>
                            <div id="exposure-time-multi" class="exposure-time-list" style="display:none;"></div>
                            <div class="result-hint">基于历史验证数据和模型计算得到的候选时间，选择不同策略会给出不同时间</div>
                        </div>
                        <div class="result-item">
                            <span class="result-label">优化策略：</span>
                            <span class="result-value" id="strategy-value">--</span>
                            <div class="result-hint">描述生成该曝光时间的算法方法及其可靠性，置信度越高代表该策略在当前数据下更准确</div>
                        </div>
                        <div class="result-item">
                            <span class="result-label">预测厚度：</span>
                            <span class="result-value" id="thickness-value">--</span>
                            <div class="result-hint">模型在所选策略与曝光时间下对最终厚度的预测值，供参考使用</div>
                        </div>

                    </div>
                    
                    <!-- 经验分析报告 -->
                    <div id="experience-analysis" class="analysis-section" style="display: none !important;">
                        <div class="analysis-header">
                            <h5>经验分析报告</h5>
                        </div>
                        <div class="analysis-content">
                            <div class="analysis-item">
                                <span class="analysis-label">趋势分析：</span>
                                <span class="analysis-value" id="trend-analysis">--</span>
                            </div>
                            <div class="analysis-item">
                                <span class="analysis-label">调整建议：</span>
                                <span class="analysis-value" id="adjustment-recommendation">--</span>
                            </div>
                            <div class="analysis-item">
                                <span class="analysis-label">加权偏差：</span>
                                <span class="analysis-value" id="weighted-deviation">--</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 训练曲线图表区域 -->
                    <div id="training-curves-section" style="display: none; margin-top: 25px;">
                        <div class="result-header">
                            <h4>训练过程曲线</h4>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef; height: 400px;">
                            <canvas id="training-loss-chart"></canvas>
                        </div>
                    </div>

                    <!-- 完整参数预测结果区域 -->
                    <div id="complete-prediction-section" style="display: none; margin-top: 25px;">
                        <div class="result-header">
                            <h4>智能参数预测结果</h4>
                            <p style="color: #666; font-size: 14px; margin: 5px 0 0 0;">基于机器学习模型预测的最优Dill模型参数配置</p>
                        </div>
                        <div id="predicted-params-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 20px;">
                            <!-- 参数卡片将通过JavaScript动态生成 -->
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
    </main>


    <!-- 页脚 -->
    <footer class="professional-footer">
        <div class="footer-main">
            <div class="footer-content">
                <div class="footer-section company-section">
                    <div class="footer-logo">
                        <i class="fas fa-atom"></i>
                        <span data-i18n="footer_brand">光刻胶建模平台</span>
                    </div>
                    <p class="footer-description" data-i18n="footer_desc">
                        基于先进的数学模型和计算方法，为半导体制造业提供专业的光刻胶建模与仿真解决方案。
                    </p>
                    <div class="footer-badges">
                        <span class="badge" data-i18n="badge_research">科研级</span>
                        <span class="badge" data-i18n="badge_professional">专业版</span>
                        <span class="badge" data-i18n="badge_verified">已验证</span>
                    </div>
                    
                    <!-- 添加页脚LOGO区域 - 放在徽章下方 -->
                    <div class="footer-logos">
                        <img src="assets/images/LOGO.avif" alt="香港大学校徽" class="footer-university-logo" title="香港大学">
                        <img src="assets/images/Dept new logo.avif" alt="学院LOGO" class="footer-department-logo" title="机械工程系">
                    </div>
                </div>
                <div class="footer-section links-section">
                    <h4 class="footer-title" data-i18n="footer_platform">平台功能</h4>
                    <ul class="footer-links">
                        <li><a href="index.html" data-i18n="footer_single">单一模型计算</a></li>
                        <li><a href="compare.html" data-i18n="footer_compare">参数对比分析</a></li>
                        <li><a href="../matrix_visualization/" data-i18n="footer_matrix">矩阵可视化</a></li>
                        <li><a href="validation.html" data-i18n="footer_validation">结果验证</a></li>
                        <li><a href="#" data-i18n="footer_documentation">使用文档</a></li>
                    </ul>
                </div>
                <div class="footer-section models-section">
                    <h4 class="footer-title" data-i18n="footer_models">支持模型</h4>
                    <ul class="footer-links">
                        <li><span class="model-badge dill">Dill</span> <span data-i18n="footer_dill">薄胶模型</span></li>
                        <li><span class="model-badge enhanced">Enhanced</span> <span data-i18n="footer_enhanced">厚胶模型</span></li>
                        <li><span class="model-badge car">CAR</span> <span data-i18n="footer_car">化学放大模型</span></li>
                        <li><span class="model-badge custom">Custom</span> <span data-i18n="footer_custom">自定义模型</span></li>
                    </ul>
                </div>
                <div class="footer-section contact-section">
                    <h4 class="footer-title" data-i18n="footer_contact">联系我们</h4>
                    <div class="contact-info">
                        <div class="contact-item">
                            <i class="fas fa-university"></i>
                            <span data-i18n="footer_university">香港大学</span>
                        </div>
                        <div class="contact-item">
                            <i class="fas fa-envelope"></i>
                            <span>mech@hku.hk</span>
                        </div>
                        <div class="contact-item">
                            <i class="fas fa-phone"></i>
                            <span>Tel: (852) 3917 2635</span>
                        </div>
                        <div class="contact-item">
                            <i class="fas fa-fax"></i>
                            <span>Fax: (852) 2858 5415</span>
                        </div>
                        <div class="contact-item">
                            <i class="fas fa-globe-asia"></i>
                            <a href="https://mech.hku.hk/" target="_blank" rel="noopener" style="color: inherit; text-decoration: none;">mech.hku.hk</a>
                        </div>
                        <div class="contact-item">
                            <i class="fas fa-code-branch"></i>
                            <span data-i18n="footer_version">版本 v2.1.0</span>
                        </div>
                        <div class="contact-item">
                            <i class="fab fa-github" aria-hidden="true"></i>
                            <a href="https://github.com/AlexLIAOPOLY/DILL-Model" target="_blank" rel="noopener" 
                               style="color: inherit; text-decoration: none; display:inline-flex; align-items:center; gap:6px;">
                                <svg aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" focusable="false">
                                    <path d="M12 0.5C5.73 0.5 0.8 5.43 0.8 11.7c0 4.88 3.16 9.02 7.54 10.48.55.1.75-.24.75-.53 0-.26-.01-.94-.01-1.85-3.07.67-3.72-1.48-3.72-1.48-.5-1.27-1.22-1.61-1.22-1.61-.99-.68.08-.67.08-.67 1.09.08 1.66 1.12 1.66 1.12.97 1.66 2.55 1.18 3.17.9.1-.7.38-1.18.69-1.45-2.45-.28-5.02-1.23-5.02-5.48 0-1.21.43-2.19 1.12-2.96-.11-.28-.48-1.41.11-2.94 0 0 .92-.29 3.02 1.13.87-.24 1.8-.36 2.73-.36s1.86.12 2.73.36c2.1-1.42 3.02-1.13 3.02-1.13.59 1.53.22 2.66.11 2.94.69.77 1.12 1.75 1.12 2.96 0 4.26-2.58 5.2-5.04 5.48.39.33.73.98.73 1.98 0 1.43-.01 2.58-.01 2.94 0 .29.2.64.76.53 4.37-1.46 7.53-5.6 7.53-10.48C23.2 5.43 18.27 0.5 12 0.5z"/>
                                </svg>
                                GitHub开源
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <div class="footer-bottom-content">
                <div class="copyright">
                    <p>&copy; 2025 <strong data-i18n="footer_copyright_org">香港大学光刻胶建模研究中心</strong>. <span data-i18n="footer_rights">保留所有权利</span>.</p>
                </div>
                <div class="footer-meta">
                    <a href="https://mech.hku.hk/blank" target="_blank" rel="noopener" class="footer-link" data-i18n="footer_privacy">隐私政策</a>
                    <span class="footer-separator">|</span>
                    <a href="https://mech.hku.hk/safety" target="_blank" rel="noopener" class="footer-link" data-i18n="footer_terms">安全政策</a>
                    <span class="footer-separator">|</span>
                    <a href="#" class="footer-link" data-i18n="footer_support">技术支持</a>
                </div>
            </div>
        </div>
    </footer>

    <!-- 参数预测输入弹窗 -->
    <div id="prediction-input-modal" class="annotation-modal">
        <div class="annotation-modal-content" style="width: 520px; max-width: 90vw; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.15);">
            <div class="annotation-modal-header" style="background: linear-gradient(180deg, #ffffff 0%, #edf7ff 100%); color: #0f172a; border-radius: 16px 16px 0 0; padding: 20px 24px; text-align: left; border-bottom: 1px solid #e5e7eb;">
                <h3 style="margin: 0; font-size: 20px; font-weight: 600;">智能参数预测</h3>
                <p style="margin: 6px 0 0 0; font-size: 14px; color: #475569;">输入目标条件，AI为您推荐最优参数组合</p>
                <button class="close-btn" onclick="closePredictionInputModal()" style="position: absolute; top: 16px; right: 16px; background: transparent; color: #64748b; border: none; border-radius: 50%; width: 32px; height: 32px; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center;">×</button>
            </div>
            <div class="annotation-modal-body" style="padding: 32px 24px;">
                <div class="prediction-form-grid" style="display: grid; gap: 24px;">
                    <!-- 模型选择 -->
                    <div class="input-group-enhanced" style="position: relative;">
                        <label class="input-label-enhanced" for="prediction-model-select" style="display: block; font-weight: 600; color: #333; margin-bottom: 8px; font-size: 14px;">
                            选择预测模型
                            <span style="color: #999; font-weight: normal; font-size: 12px; margin-left: 8px;">请选择要使用的训练模型</span>
                        </label>
                        <select id="prediction-model-select" 
                                style="width: 100%; padding: 14px 16px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px; transition: all 0.3s ease; box-sizing: border-box; background: white;"
                                onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102,126,234,0.1)'"
                                onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='none'"
                                onchange="updateModelInfo(this.value)">
                            <option value="linear_regression">线性回归 - Linear Regression</option>
                            <option value="random_forest">随机森林 - Random Forest</option>
                            <option value="svm">支持向量机 - SVM</option>
                        </select>
                        <div id="model-status-info" style="margin-top: 6px; padding: 8px 12px; background: #f8f9fa; border-radius: 6px;">
                            <small id="model-status-text" style="color: #28a745; font-size: 12px; font-weight: 500;">✅ 模型已训练，可用于预测</small>
                        </div>
                    </div>

                    <div class="input-group-enhanced" style="position: relative;">
                        <label class="input-label-enhanced" for="target-x" style="display: block; font-weight: 600; color: #333; margin-bottom: 8px; font-size: 14px;">
                            目标X坐标
                            <span id="target-x-unit" style="color: #999; font-weight: normal; font-size: 12px; margin-left: 8px;">单位：μm</span>
                        </label>
                        <input type="number" id="target-x" placeholder="输入X坐标" value="0" step="0.1" 
                               style="width: 100%; padding: 14px 16px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px; transition: all 0.3s ease; box-sizing: border-box;"
                               onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102,126,234,0.1)'"
                               onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='none'">
                    </div>
                    

                    <div class="input-group-enhanced" style="position: relative;">
                        <label class="input-label-enhanced" for="target-thickness" style="display: block; font-weight: 600; color: #333; margin-bottom: 8px; font-size: 14px;">
                            期待厚度
                            <span style="color: #999; font-weight: normal; font-size: 12px; margin-left: 8px;">单位：μm</span>
                        </label>
                        <input type="number" id="target-thickness" placeholder="输入期待厚度" value="1.0" step="0.001" min="0.001" 
                               style="width: 100%; padding: 14px 16px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px; transition: all 0.3s ease; box-sizing: border-box;"
                               onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102,126,234,0.1)'"
                               onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='none'">
                        <div style="margin-top: 6px; padding: 8px 12px; background: #f8f9fa; border-radius: 6px;">
                            <small style="color: #28a745; font-size: 12px; font-weight: 500;">建议范围：0.1 - 2.0 μm</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="annotation-modal-footer" style="padding: 0 24px 24px 24px; display: flex; gap: 12px; justify-content: flex-end;">
                <button type="button" onclick="closePredictionInputModal()" 
                        style="background: #f8f9fa; color: #6c757d; border: 2px solid #e9ecef; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s ease;"
                        onmouseover="this.style.background='#e9ecef'"
                        onmouseout="this.style.background='#f8f9fa'">
                    取消
                </button>
                <button type="button" onclick="startPrediction()" 
                        style="background: #0ea5e9; color: white; border: none; padding: 12px 32px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s ease; box-shadow: 0 4px 12px rgba(14,165,233,0.25);"
                        onmouseover="this.style.transform='translateY(-1px)'; this.style.background='#0284c7'"
                        onmouseout="this.style.transform='translateY(0)'; this.style.background='#0ea5e9'">
                    开始预测
                </button>
            </div>
        </div>
    </div>

    <!-- 自定义标注弹窗 -->
    <div id="annotation-modal" class="annotation-modal">
        <div class="annotation-modal-content">
            <div class="annotation-modal-header">
                <h3>
                    数据点标注
                </h3>
                <button class="close-btn" onclick="closeAnnotationModal()">
                    ×
                </button>
            </div>
            <div class="annotation-modal-body">
                <div class="coordinate-info">
                    <div class="coordinate-row">
                        <span class="coordinate-label">X坐标位置:</span>
                        <span class="coordinate-value" id="modal-x-coord">--</span>
                    </div>
                    <div class="coordinate-row">
                        <span class="coordinate-label">模拟厚度值:</span>
                        <span class="coordinate-value" id="modal-simulated-value">--</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <label class="input-label" for="actual-measurement">
                        请输入实际测量的厚度值 (μm):
                    </label>
                    <input 
                        type="number" 
                        id="actual-measurement" 
                        class="measurement-input" 
                        step="0.001" 
                        min="0"
                        placeholder="请输入测量值 (μm)..."
                    >
                </div>
                
                <div class="modal-buttons">
                    <button class="modal-btn modal-btn-cancel" onclick="closeAnnotationModal()">
                        取消
                    </button>
                    <button class="modal-btn modal-btn-confirm" onclick="confirmAnnotation()">
                        确认标注
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 手动输入坐标弹窗 -->
    <div id="manual-annotation-modal" class="annotation-modal">
        <div class="annotation-modal-content">
            <div class="annotation-modal-header">
                <h3>
                    手动添加标注
                </h3>
                <button class="close-btn" onclick="closeManualAnnotationModal()">
                    ×
                </button>
            </div>
            <div class="annotation-modal-body">
                <div class="input-group">
                    <label class="input-label" for="manual-x-coord">
                        X坐标 (μm):
                    </label>
                    <input 
                        type="number" 
                        id="manual-x-coord" 
                        class="measurement-input" 
                        step="0.01"
                        placeholder="请输入X坐标值..."
                    >
                </div>
                
                
                <div class="coordinate-info">
                    <div class="coordinate-row">
                        <span class="coordinate-label">计算的模拟厚度值:</span>
                        <span class="coordinate-value" id="manual-simulated-value">--</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <label class="input-label" for="manual-actual-measurement">
                        实际测量的厚度值 (μm):
                    </label>
                    <input 
                        type="number" 
                        id="manual-actual-measurement" 
                        class="measurement-input" 
                        step="0.001" 
                        min="0"
                        placeholder="请输入实际测量值..."
                    >
                </div>
                
                <div class="modal-buttons">
                    <button class="modal-btn modal-btn-cancel" onclick="closeManualAnnotationModal()">
                        取消
                    </button>
                    <button class="modal-btn modal-btn-primary" onclick="calculateSimulatedValue()">
                        计算模拟值
                    </button>
                    <button class="modal-btn modal-btn-success" onclick="confirmManualAnnotation()">
                        确认添加
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 智能优化输入弹窗 -->
    <div id="optimization-modal" class="optimization-modal">
        <div class="optimization-modal-content">
            <div class="optimization-modal-header">
                <h3>
                    智能曝光时间优化
                </h3>
                <button class="close-btn" onclick="closeOptimizationModal()">
                    ×
                </button>
            </div>
            <div class="optimization-modal-body">
                <div class="input-row">
                    <div class="input-group-opt">
                        <label class="input-label-opt" for="target-x-coord">
                            目标X坐标 (μm):
                        </label>
                        <input 
                            type="number" 
                            id="target-x-coord" 
                            class="input-field-opt" 
                            step="0.1"
                            placeholder="例如: 0"
                            value="0"
                            oninput="updateSimulatedThickness()"
                        >
                    </div>
                    <div class="input-group-opt y-coord-field" id="target-y-coord-row">
                        <label class="input-label-opt" for="target-y-coord">
                            目标Y坐标 (μm):
                        </label>
                        <input 
                            type="number" 
                            id="target-y-coord" 
                            class="input-field-opt" 
                            step="0.1"
                            placeholder="例如: 0"
                            value="0"
                            oninput="updateSimulatedThickness()"
                        >
                    </div>
                </div>
                
                <!-- 当前位置的模拟厚度显示 -->
                <div class="coordinate-info" style="margin-bottom: 20px;">
                    <div class="coordinate-row">
                        <span class="coordinate-label">当前位置的模拟厚度:</span>
                        <span class="coordinate-value" id="current-simulated-thickness">--</span>
                    </div>
                </div>
                
                <div class="input-group-opt">
                    <label class="input-label-opt" for="target-thickness">
                        期望厚度 (μm):
                    </label>
                    <input 
                        type="number" 
                        id="target-thickness" 
                        class="input-field-opt" 
                        step="0.001" 
                        min="0"
                        placeholder="例如: 1.000"
                        value="1.000"
                    >
                </div>
                
                <div class="modal-buttons-opt">
                    <button class="modal-btn modal-btn-cancel" onclick="closeOptimizationModal()">
                        取消
                    </button>
                    <button class="modal-btn modal-btn-confirm" onclick="performSmartOptimization()">
                        开始优化
                    </button>
                </div>
                
                <!-- 优化结果显示区域 -->
                <div id="optimization-results" class="optimization-results">
                    <div class="result-title">
                        推荐的曝光时间选项
                    </div>
                    <div class="exposure-options" id="exposure-options-container">
                        <!-- 动态生成的曝光时间选项 -->
                    </div>
                    <div class="modal-buttons-opt" style="margin-top: 20px;">
                        <button class="modal-btn modal-btn-confirm" onclick="applySelectedExposure()">
                            应用选择的参数
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 训练参数设置弹窗 -->
    <div id="training-settings-modal" class="annotation-modal">
        <div class="annotation-modal-content" style="width: 520px;">
            <div class="annotation-modal-header">
                <h3>
                    模型训练参数设置
                </h3>
                <button class="close-btn" onclick="closeTrainingSettingsModal()">
                    ×
                </button>
            </div>
            <div class="annotation-modal-body">
                <div class="input-group">
                    <label class="input-label" for="training-epochs">
                        训练轮数 (Epochs):
                    </label>
                    <input 
                        type="number" 
                        id="training-epochs" 
                        class="measurement-input" 
                        value="100" 
                        min="10" 
                        max="1000"
                        step="10"
                    >
                    <small style="color: #6c757d; font-size: 12px; margin-top: 5px; display: block;">
                        建议范围：50-200轮，数据量大时可适当增加
                    </small>
                </div>
                
                <div class="input-group">
                    <label class="input-label" for="test-size">
                        测试集比例 (%):
                    </label>
                    <input 
                        type="number" 
                        id="test-size" 
                        class="measurement-input" 
                        value="20" 
                        min="10" 
                        max="40"
                        step="5"
                    >
                    <small style="color: #6c757d; font-size: 12px; margin-top: 5px; display: block;">
                        用于验证模型性能的数据比例
                    </small>
                </div>
                
                <div class="input-group">
                    <label class="input-label" for="model-type-select">
                        模型类型:
                    </label>
                    <select id="model-type-select" class="measurement-input">
                        <option value="random_forest">随机森林 (推荐)</option>
                        <option value="linear_regression">线性回归</option>
                        <option value="svm">支持向量机</option>
                    </select>
                    <small style="color: #6c757d; font-size: 12px; margin-top: 5px; display: block;">
                        随机森林适合大多数情况，线性回归适合简单关系
                    </small>
                </div>

                <div class="input-group">
                    <label class="input-label">
                        <input type="checkbox" id="enable-cross-validation" checked style="margin-right: 8px;">
                        启用交叉验证
                    </label>
                    <small style="color: #6c757d; font-size: 12px; margin-top: 5px; display: block;">
                        提高模型评估的可靠性（推荐开启）
                    </small>
                </div>
                
                <div class="modal-buttons">
                    <button class="modal-btn modal-btn-cancel" onclick="closeTrainingSettingsModal()">
                        取消
                    </button>
                    <button class="modal-btn modal-btn-confirm" onclick="startTrainingWithSettings()">
                        开始训练
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 引入JavaScript文件 -->
    <script src="js/common.js?v=1.0"></script>
    <script src="js/lang.js"></script>
    <script src="js/validation.js"></script>
    
    <!-- 通知系统脚本 -->
    <script>
        // 全局变量，用于访问当前厚度数据
        let currentThicknessData = null;
        
        // 初始化折叠功能
        function initCollapsibleSection() {
            const title = document.getElementById('parameters-section-title');
            const content = document.getElementById('parameters-content');
            const icon = document.getElementById('parameters-collapse-icon');
            
            if (title && content && icon) {
                title.addEventListener('click', function() {
                    const isCollapsed = content.classList.contains('collapsed');
                    
                    if (isCollapsed) {
                        // 展开
                        content.classList.remove('collapsed');
                        title.classList.remove('collapsed');
                        icon.classList.remove('fa-chevron-right');
                        icon.classList.add('fa-chevron-down');
                    } else {
                        // 折叠
                        content.classList.add('collapsed');
                        title.classList.add('collapsed');
                        icon.classList.remove('fa-chevron-down');
                        icon.classList.add('fa-chevron-right');
                    }
                });
            }
        }

        // 全局变量存储验证数据和选择状态
        let validationRecords = [];
        let selectedRecordIndices = [];

        // 页面加载完成后绑定事件
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化折叠功能
            initCollapsibleSection();
            
            // 绑定验证数据选择器按钮
            const showValidationSelectorBtn = document.getElementById('show-validation-selector');
            if (showValidationSelectorBtn) {
                showValidationSelectorBtn.addEventListener('click', showValidationDataSelector);
            }
            
            // 绑定快捷优化按钮事件
            const smartOptimizeBtn = document.getElementById('smart-optimize');
            if (smartOptimizeBtn) {
                smartOptimizeBtn.addEventListener('click', function() {
                    // 显示加载状态
                    smartOptimizeBtn.textContent = '优化中...';
                    smartOptimizeBtn.disabled = true;
                    
                    // 调用真实的快捷优化API
                    fetch('/api/smart_optimize_exposure', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            target_x: 0,
                            target_y: 0,
                            target_thickness: 1.0
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        // 恢复按钮状态
                        smartOptimizeBtn.textContent = '快捷优化';
                        smartOptimizeBtn.disabled = false;
                        
                        if (data.success) {
                            // 从优化选项中选择第一个结果显示
                            const options = data.data?.exposure_options || data.exposure_options;
                            console.log('收到优化数据:', data);
                            console.log('解析的选项:', options);
                            
                            if (options && options.length > 0) {
                                const firstOption = options[0];
                                const exposureTime = firstOption.exposure_time || firstOption.t_exp || 0;
                                const targetThickness = firstOption.predicted_thickness || firstOption.target_thickness || target_thickness;
                                
                                console.log('使用的选项:', firstOption);
                                console.log('曝光时间:', exposureTime, '目标厚度:', targetThickness);
                                
                                showOptimizationResult(exposureTime, targetThickness);
                            } else {
                                console.error('未找到有效的优化选项:', data);
                                alert('优化成功但未返回具体结果');
                            }
                        } else {
                            alert('优化失败：' + (data.message || data.error || '未知错误'));
                        }
                    })
                    .catch(error => {
                        // 恢复按钮状态
                        smartOptimizeBtn.textContent = '快捷优化';
                        smartOptimizeBtn.disabled = false;
                        
                        console.error('快捷优化API调用失败:', error);
                        alert('网络错误，请检查连接后重试');
                    });
                });
            }

            // 绑定自定义优化按钮事件
            const customOptimizeBtn = document.getElementById('show-optimization-input');
            if (customOptimizeBtn) {
                customOptimizeBtn.addEventListener('click', function() {
                    // 显示加载状态
                    customOptimizeBtn.textContent = '正在优化...';
                    customOptimizeBtn.disabled = true;
                    
                    // 调用真实的自定义优化API
                    fetch('/api/smart_optimize_exposure', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            target_x: 0,
                            target_y: 0,
                            target_thickness: 0.8  // 自定义优化使用不同的目标厚度
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        // 恢复按钮状态
                        customOptimizeBtn.textContent = '自定义优化';
                        customOptimizeBtn.disabled = false;
                        
                        if (data.success) {
                            // 从优化选项中选择第二个结果显示（区别于快捷优化）
                            const options = data.data?.exposure_options || data.exposure_options;
                            console.log('收到自定义优化数据:', data);
                            console.log('解析的选项:', options);
                            
                            if (options && options.length > 1) {
                                const customOption = options[1]; // 使用第二个选项
                                const exposureTime = customOption.exposure_time || customOption.t_exp || 0;
                                const targetThickness = customOption.predicted_thickness || customOption.target_thickness || 0.8;
                                
                                showCustomOptimizationResult(exposureTime, '自定义策略', targetThickness);
                            } else if (options && options.length > 0) {
                                const customOption = options[0]; // 如果只有一个选项
                                const exposureTime = customOption.exposure_time || customOption.t_exp || 0;
                                const targetThickness = customOption.predicted_thickness || customOption.target_thickness || 0.8;
                                
                                showCustomOptimizationResult(exposureTime, '自定义策略', targetThickness);
                            } else {
                                console.error('未找到有效的自定义优化选项:', data);
                                alert('自定义优化成功但未返回具体结果');
                            }
                        } else {
                            alert('自定义优化失败：' + (data.message || data.error || '未知错误'));
                        }
                    })
                    .catch(error => {
                        // 恢复按钮状态
                        customOptimizeBtn.textContent = '自定义优化';
                        customOptimizeBtn.disabled = false;
                        
                        console.error('自定义优化API调用失败:', error);
                        alert('网络错误，请检查连接后重试');
                    });
                });
            }

            // 绑定训练设置按钮事件
            const showTrainingSettingsBtn = document.getElementById('show-training-settings');
            if (showTrainingSettingsBtn) {
                showTrainingSettingsBtn.addEventListener('click', function() {
                    document.getElementById('training-settings-modal').style.display = 'block';
                });
            }

            // 绑定训练模型按钮事件（保留原有逻辑作为备用）
            const trainModelBtn = document.getElementById('train-model');
            if (trainModelBtn) {
                trainModelBtn.addEventListener('click', function() {
                    // 显示加载状态
                    trainModelBtn.textContent = '训练中...';
                    trainModelBtn.disabled = true;
                    
                    // 调用真实的模型训练API
                    fetch('/api/train_model', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({})
                    })
                    .then(response => response.json())
                    .then(data => {
                        // 恢复按钮状态
                        trainModelBtn.textContent = '训练模型';
                        trainModelBtn.disabled = false;
                        
                        if (data.success) {
                            // 显示真实训练结果
                            console.log('训练成功，收到数据:', data);
                            const accuracy = data.data?.accuracy || data.accuracy || 0;
                            const trainingsamples = data.data?.training_samples || data.training_samples || 0;
                            const mse = data.data?.mse || data.mse;
                            const r2Score = data.data?.r2_score || data.r2_score;
                            
                            showTrainingResult(accuracy, trainingsamples);
                            
                            // 在控制台显示详细训练信息
                            console.log(`✅ 模型训练完成！`);
                            console.log(`📊 准确率 (R²): ${(accuracy * 100).toFixed(1)}%`);
                            console.log(`📈 均方误差 (MSE): ${mse?.toFixed(4) || 'N/A'}`);
                            console.log(`🎯 R²分数: ${r2Score?.toFixed(4) || 'N/A'}`);
                            console.log(`📚 训练样本数: ${trainingsamples}`);
                            console.log(`💾 模型文件: validation_model.pkl`);
                        } else {
                            const errorMsg = data.message || data.error || '未知错误';
                            if (errorMsg.includes('验证数据文件') || errorMsg.includes('validation_data')) {
                                alert('请先进行一些验证操作来生成训练数据，然后再进行模型训练。');
                            } else {
                                alert('训练失败：' + errorMsg);
                            }
                        }
                    })
                    .catch(error => {
                        // 恢复按钮状态
                        trainModelBtn.textContent = '训练模型';
                        trainModelBtn.disabled = false;
                        
                        console.error('模型训练API调用失败:', error);
                        alert('网络错误，请检查连接后重试');
                    });
                });
            }

            // 绑定参数预测按钮事件
            const predictBtn = document.getElementById('predict-parameters');
            if (predictBtn) {
                // 参数预测按钮默认启用，可使用现有模型
                predictBtn.disabled = false;
                predictBtn.style.opacity = '1';
                predictBtn.style.cursor = 'pointer';
                
                predictBtn.addEventListener('click', function() {
                    if (predictBtn.disabled) {
                        alert('请先完成模型训练');
                        return;
                    }
                    
                    // 显示参数输入弹窗
                    showPredictionInputModal();
                });
            }
        });

        // 简单的结果显示函数
        function showResult(title, exposureTime, strategy, thickness) {
            const resultSection = document.getElementById('optimization-result-section');
            const titleElement = document.getElementById('result-title');
            const exposureElement = document.getElementById('exposure-time-value');
            const strategyElement = document.getElementById('strategy-value');
            const thicknessElement = document.getElementById('thickness-value');

            if (resultSection && titleElement && exposureElement && strategyElement && thicknessElement) {
                titleElement.textContent = title;
                exposureElement.textContent = exposureTime;
                strategyElement.textContent = strategy;
                thicknessElement.textContent = thickness;
                
                resultSection.style.display = 'block';
                
                // 滚动由智能优化统一处理
                // setTimeout(() => {
                //     resultSection.scrollIntoView({ 
                //         behavior: 'smooth', 
                //         block: 'center' 
                //     });
                // }, 100);
            }
        }

        // 快捷优化结果显示
        function showOptimizationResult(exposureTime, targetThickness) {
            showResult('快捷优化结果', `${exposureTime}s`, '标准策略', `${targetThickness}μm`);
        }

        // 训练结果显示
        function showTrainingResult(accuracy, trainingsamples) {
            const resultSection = document.getElementById('optimization-result-section');
            const titleElement = document.getElementById('result-title');
            const exposureElement = document.getElementById('exposure-time-value');
            const strategyElement = document.getElementById('strategy-value');
            const thicknessElement = document.getElementById('thickness-value');

            if (resultSection && titleElement && exposureElement && strategyElement && thicknessElement) {
                titleElement.textContent = '模型训练完成';
                
                // 修改标签文本以匹配训练结果
                const exposureLabel = exposureElement.previousElementSibling;
                const strategyLabel = strategyElement.previousElementSibling;
                const thicknessLabel = thicknessElement.previousElementSibling;
                
                exposureLabel.textContent = '模型文件：';
                strategyLabel.textContent = '训练准确度：';
                thicknessLabel.textContent = '训练数据：';
                
                exposureElement.textContent = 'validation_model.pkl';
                strategyElement.textContent = `${(accuracy * 100).toFixed(1)}%`;
                thicknessElement.textContent = `${trainingsamples} 条记录`;
                
                resultSection.style.display = 'block';
                
                // 滚动由智能优化统一处理
                // setTimeout(() => {
                //     resultSection.scrollIntoView({ 
                //         behavior: 'smooth', 
                //         block: 'center' 
                //     });
                // }, 100);
            }
            
            // 训练完成后启用参数预测按钮
            const predictBtn = document.getElementById('predict-parameters');
            if (predictBtn) {
                predictBtn.disabled = false;
                predictBtn.style.opacity = '1';
                predictBtn.style.cursor = 'pointer';
            }
            
            // 显示模型保存信息提示
            setTimeout(() => {
                const modelPath = '/Users/liaowang/Desktop/Dill Model/Dill/DILL/dill_model/validation_model.pkl';
                console.log(`✅ 模型已保存到: ${modelPath}`);
                console.log('📊 模型类型: RandomForestRegressor (随机森林回归)');
                console.log('🎯 用途: 预测光刻胶厚度参数');
            }, 500);
        }

        // 自定义优化结果显示
        function showCustomOptimizationResult(exposureTime, strategy, thickness) {
            showResult('自定义优化结果', `${exposureTime}s`, strategy, `${thickness}μm`);
        }

        // 参数预测结果显示
        function showPredictionResult(exposureTime, strategy, thickness) {
            const resultSection = document.getElementById('optimization-result-section');
            const titleElement = document.getElementById('result-title');
            const exposureElement = document.getElementById('exposure-time-value');
            const strategyElement = document.getElementById('strategy-value');
            const thicknessElement = document.getElementById('thickness-value');

            if (resultSection && titleElement && exposureElement && strategyElement && thicknessElement) {
                titleElement.textContent = '参数预测结果';
                
                // 重置标签为预测模式
                const exposureLabel = exposureElement.previousElementSibling;
                const strategyLabel = strategyElement.previousElementSibling;
                const thicknessLabel = thicknessElement.previousElementSibling;
                
                exposureLabel.textContent = '推荐曝光时间：';
                strategyLabel.textContent = '优化策略：';
                thicknessLabel.textContent = '建议预测厚度：';
                
                exposureElement.textContent = `${exposureTime}s`;
                strategyElement.textContent = strategy;
                thicknessElement.textContent = `${thickness}μm`;
                
                resultSection.style.display = 'block';
                
                // 滚动由智能优化统一处理
                // setTimeout(() => {
                //     resultSection.scrollIntoView({ 
                //         behavior: 'smooth', 
                //         block: 'center' 
                //     });
                // }, 100);
            }
        }

        function showValidationResult(totalPoints, accuracy) {
            const details = [
                { label: '验证数据点', value: `${totalPoints} 个` },
                { label: '验证准确度', value: `${accuracy}%`, highlight: true },
                { label: '验证完成时间', value: new Date().toLocaleTimeString() }
            ];

            inlineResult.show({
                title: '数据验证完成！',
                message: '验证数据已成功保存到Excel文件，可用于后续的模型训练。',
                icon: '✅',
                details: details
            });
        }

        // 训练设置弹窗函数
        function closeTrainingSettingsModal() {
            document.getElementById('training-settings-modal').style.display = 'none';
        }

        function startTrainingWithSettings() {
            // 获取训练参数
            const epochs = parseInt(document.getElementById('training-epochs').value) || 100;
            const testSize = parseFloat(document.getElementById('test-size').value) / 100 || 0.2;
            const modelType = document.getElementById('model-type-select').value || 'random_forest';
            const enableCrossValidation = document.getElementById('enable-cross-validation').checked;

            // 关闭弹窗
            closeTrainingSettingsModal();
            
            // 隐藏所有结果区域，避免重叠显示
            const sectionsToHide = [
                'complete-prediction-section',
                'optimization-result-section', 
                'training-curves-section',
                'experience-analysis',
                'validation-data-selector'
            ];
            
            sectionsToHide.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.style.display = 'none';
                }
            });

            // 显示训练状态
            const showTrainingSettingsBtn = document.getElementById('show-training-settings');
            if (showTrainingSettingsBtn) {
                showTrainingSettingsBtn.textContent = '训练中...';
                showTrainingSettingsBtn.disabled = true;
            }

            // 调用训练API
            fetch('/api/train_model', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    epochs: epochs,
                    test_size: testSize,
                    model_type: modelType,
                    enable_cross_validation: enableCrossValidation
                })
            })
            .then(response => response.json())
            .then(data => {
                // 恢复按钮状态
                if (showTrainingSettingsBtn) {
                    showTrainingSettingsBtn.textContent = '训练设置';
                    showTrainingSettingsBtn.disabled = false;
                }
                
                if (data.success) {
                    console.log('训练成功，收到数据:', data);
                    const accuracy = data.data?.accuracy || data.accuracy || 0;
                    const trainingsamples = data.data?.training_samples || data.training_samples || 0;
                    const mse = data.data?.mse || data.mse;
                    const r2Score = data.data?.r2_score || data.r2_score;
                    
                    // 显示详细的训练结果
                    showDetailedTrainingResult(accuracy, trainingsamples, {
                        epochs: epochs,
                        test_size: testSize,
                        model_type: modelType,
                        mse: mse,
                        r2_score: r2Score,
                        cross_validation: enableCrossValidation,
                        training_curves: data.data?.training_curves || data.training_curves
                    });
                    
                    // 启用参数预测按钮
                    const predictBtn = document.getElementById('predict-parameters');
                    if (predictBtn) {
                        predictBtn.disabled = false;
                        predictBtn.style.opacity = '1';
                        predictBtn.style.cursor = 'pointer';
                    }
                } else {
                    const errorMsg = data.message || data.error || '未知错误';
                    if (errorMsg.includes('验证数据文件') || errorMsg.includes('validation_data')) {
                        alert('请先进行一些验证操作来生成训练数据，然后再进行模型训练。');
                    } else {
                        alert('训练失败：' + errorMsg);
                    }
                }
            })
            .catch(error => {
                // 恢复按钮状态
                if (showTrainingSettingsBtn) {
                    showTrainingSettingsBtn.textContent = '训练设置';
                    showTrainingSettingsBtn.disabled = false;
                }
                
                console.error('模型训练API调用失败:', error);
                alert('网络错误，请检查连接后重试');
            });
        }

        // 显示详细训练结果
        function showDetailedTrainingResult(accuracy, trainingsamples, details) {
            const resultSection = document.getElementById('optimization-result-section');
            const titleElement = document.getElementById('result-title');
            const exposureElement = document.getElementById('exposure-time-value');
            const strategyElement = document.getElementById('strategy-value');
            const thicknessElement = document.getElementById('thickness-value');

            if (resultSection && titleElement && exposureElement && strategyElement && thicknessElement) {
                titleElement.textContent = '模型训练完成';
                
                // 修改标签文本以匹配训练结果
                const exposureLabel = exposureElement.previousElementSibling;
                const strategyLabel = strategyElement.previousElementSibling;
                const thicknessLabel = thicknessElement.previousElementSibling;
                
                exposureLabel.textContent = '训练准确度：';
                strategyLabel.textContent = '模型类型：';
                thicknessLabel.textContent = '训练参数：';
                
                exposureElement.textContent = `${(accuracy * 100).toFixed(1)}%`;
                strategyElement.textContent = getModelTypeDisplayName(details.model_type);
                thicknessElement.textContent = `${trainingsamples} 条数据，${details.epochs} 轮次`;
                
                // 置信度显示已删除，避免与训练准确度重复
                
                resultSection.style.display = 'block';
                
                        // 显示训练曲线（如果有数据）
        console.log('🔍 检查训练曲线数据:', details.training_curves);
        if (details.training_curves && details.training_curves.epochs && details.training_curves.epochs.length >= 1) {
            console.log('✅ 调用 showTrainingCurves, 数据点数量:', details.training_curves.epochs.length);
            showTrainingCurves(details.training_curves, details.model_type);
        } else {
            console.log('⚠️ 训练曲线数据不足，显示警告');
            // 显示数据不足的提示
            showDataInsufficiencyWarning();
        }
                
                // 滚动由智能优化统一处理
                // setTimeout(() => {
                //     resultSection.scrollIntoView({ 
                //         behavior: 'smooth', 
                //         block: 'center' 
                //     });
                // }, 100);
            }
        }

        // 显示训练曲线
        function showTrainingCurves(trainingCurves, modelType) {
            console.log('📊 showTrainingCurves 被调用', { trainingCurves, modelType });
            
            const curvesSection = document.getElementById('training-curves-section');
            if (!curvesSection) {
                console.error('⚠️ 找不到 training-curves-section 元素');
                return;
            }
            
            curvesSection.style.display = 'block';
            console.log('✅ 训练曲线区域已显示');
            
            // 彻底清理所有Chart实例和全局状态
            console.log('🧹 开始彻底清理Chart状态...');
            
            // 销毁现有图表实例
            if (window.trainingChart) {
                console.log('🗑️ 销毁现有图表实例');
                try {
                    window.trainingChart.destroy();
                    window.trainingChart = null;
                    delete window.trainingChart;
                } catch (e) {
                    console.warn('销毁图表时出错:', e);
                    window.trainingChart = null;
                }
            }
            
            // 清理Chart.js全局注册表
            if (window.Chart && window.Chart.instances) {
                console.log('🧹 清理Chart.js全局实例注册表');
                Object.keys(window.Chart.instances).forEach(key => {
                    try {
                        const instance = window.Chart.instances[key];
                        if (instance && typeof instance.destroy === 'function') {
                            instance.destroy();
                        }
                        delete window.Chart.instances[key];
                    } catch (e) {
                        console.warn('清理Chart实例失败:', e);
                    }
                });
            }
            
            // 完全重新创建图表容器
            console.log('🔄 重新创建图表容器');
            const oldContainer = curvesSection.querySelector('div[style*="background: white"]');
            if (oldContainer) {
                curvesSection.removeChild(oldContainer);
            }
            
            const chartContainer = document.createElement('div');
            chartContainer.style.cssText = 'background: white; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef; height: 400px;';
            curvesSection.appendChild(chartContainer);
            
            // 生成完全唯一的canvas ID
            const timestamp = Date.now();
            const random = Math.floor(Math.random() * 10000);
            const canvasId = `chart-canvas-${timestamp}-${random}`;
            
            // 创建canvas元素
            chartContainer.innerHTML = `<canvas id="${canvasId}" style="width: 100%; height: 100%;"></canvas>`;
            
            // 等待DOM更新
            setTimeout(() => {
                const ctx = document.getElementById(canvasId);
                if (!ctx) {
                    console.error('⚠️ 找不到 canvas 元素');
                    chartContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #dc3545;">Canvas元素创建失败</div>';
                    return;
                }
                
                console.log('📊 Canvas准备就绪，ID:', canvasId);
                
                // 开始创建图表
                createTrainingChart(ctx, trainingCurves, modelType, canvasId);
            }, 100);
        }
        
        // 独立的图表创建函数
        function createTrainingChart(ctx, trainingCurves, modelType, canvasId) {
            console.log('🎨 开始创建训练图表...', {modelType, canvasId});
            
            // 检查 Chart.js 是否可用
            if (typeof Chart === 'undefined') {
                console.error('⚠️ Chart.js 未加载');
                const container = ctx.parentElement;
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #dc3545;">Chart.js 未加载，无法显示图表</div>';
                return;
            }
            
            // 根据模型类型确定x轴标签
            let xAxisLabel = '';
            switch(modelType) {
                case 'random_forest':
                    xAxisLabel = '树的数量';
                    break;
                case 'svm':
                    xAxisLabel = '参数组合';
                    break;
                case 'linear_regression':
                    xAxisLabel = '训练完成';
                    break;
                default:
                    xAxisLabel = 'Epochs';
            }
            
            // 准备数据集
            const datasets = [];
            
            // 训练R²数据
            if (trainingCurves.train_r2 && trainingCurves.train_r2.length > 0) {
                datasets.push({
                    label: '训练集 R²',
                    data: trainingCurves.train_r2,
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.1,
                    pointRadius: 4,
                    pointHoverRadius: 6
                });
            }
            
            // 验证R²数据
            if (trainingCurves.val_r2 && trainingCurves.val_r2.length > 0) {
                datasets.push({
                    label: '验证集 R²',
                    data: trainingCurves.val_r2,
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.1,
                    pointRadius: 4,
                    pointHoverRadius: 6
                });
            }
            
            // 训练MSE数据（备用）
            if (datasets.length === 0 && trainingCurves.train_loss && trainingCurves.train_loss.length > 0) {
                datasets.push({
                    label: '训练MSE',
                    data: trainingCurves.train_loss,
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6
                });
                
                if (trainingCurves.val_loss && trainingCurves.val_loss.length > 0) {
                    datasets.push({
                        label: '验证MSE',
                        data: trainingCurves.val_loss,
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    });
                }
            }
            
            if (datasets.length === 0) {
                console.error('⚠️ 没有可用的训练数据');
                const container = ctx.parentElement;
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #dc3545;">没有可用的训练数据</div>';
                return;
            }
            
            // 使用try-catch包装Chart创建
            try {
                console.log('📊 创建Chart实例...');
                const chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: trainingCurves.epochs,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `${getModelTypeDisplayName(modelType)} - 训练过程曲线`,
                                font: {
                                    size: 16
                                }
                            },
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                title: {
                                    display: true,
                                    text: xAxisLabel
                                }
                            },
                            y: {
                                display: true,
                                title: {
                                    display: true,
                                    text: datasets.some(d => d.label.includes('R²')) ? 'R² 分数' : '均方误差 (MSE)'
                                },
                                min: datasets.some(d => d.label.includes('R²')) ? -0.5 : undefined,
                                max: datasets.some(d => d.label.includes('R²')) ? 1.0 : undefined
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        }
                    }
                });
                
                // 保存图表引用
                window.trainingChart = chart;
                console.log('✅ 训练曲线图表创建成功');
                
            } catch (error) {
                console.error('⚠️ 创建训练曲线图表失败:', error);
                const container = ctx.parentElement;
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #dc3545;">图表创建失败: ' + error.message + '</div>';
            }
        }

        // 获取模型类型显示名称
        function getModelTypeDisplayName(modelType) {
            const typeNames = {
                'random_forest': '随机森林',
                'linear_regression': '线性回归',
                'svm': '支持向量机'
            };
            return typeNames[modelType] || modelType;
        }

        // 显示数据不足警告
        function showDataInsufficiencyWarning() {
            const curvesSection = document.getElementById('training-curves-section');
            if (!curvesSection) return;
            
            curvesSection.style.display = 'block';
            
            // 销毁现有图表（如果存在）
            if (window.trainingChart) {
                window.trainingChart.destroy();
            }
            
            const chartContainer = curvesSection.querySelector('div[style*="background: white"]');
            if (chartContainer) {
                chartContainer.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 20px;">⚠️</div>
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">训练数据样本不足</div>
                        <div style="font-size: 14px; text-align: center; line-height: 1.5;">
                            当前数据量较少，无法生成可靠的训练曲线<br>
                            建议收集更多验证数据（建议至少10个样本）以获得更好的训练效果<br>
                            <span style="color: #007bff;">目前主要通过交叉验证评估模型性能</span>
                        </div>
                    </div>
                `;
            }
        }

        // 显示完整的参数预测结果
        function showCompletePredictionResult(predictedParams, targetInfo) {
            const predictionSection = document.getElementById('complete-prediction-section');
            const paramsGrid = document.getElementById('predicted-params-grid');
            
            if (!predictionSection || !paramsGrid) return;
            
            // 显示预测结果区域
            predictionSection.style.display = 'block';
            
            // 定义参数分组和显示配置
            const paramGroups = [
                {
                    title: '光学参数',
                    color: '#007bff',
                    params: [
                        { key: 'I_avg', label: '平均光强', unit: '', precision: 3 },
                        { key: 'V', label: '对比度', unit: '', precision: 3 },
                        { key: 'K', label: '空间频率', unit: 'rad/μm', precision: 3 },
                        { key: 'wavelength', label: '波长', unit: 'nm', precision: 1 },
                        { key: 'angle_a', label: '衍射周期', unit: '°', precision: 2 }
                    ]
                },
                {
                    title: '曝光参数',
                    color: '#28a745',
                    params: [
                        { key: 't_exp', label: '曝光时间', unit: 's', precision: 2 },
                        { key: 'C', label: '光敏速率常数', unit: 'cm²/mJ', precision: 4 },
                        { key: 'exposure_threshold', label: '曝光阈值', unit: 'mJ/cm²', precision: 1 },
                        { key: 'exposure_dose', label: '总曝光剂量', unit: 'mJ/cm²', precision: 1 }
                    ]
                },
                {
                    title: '推导参数',
                    color: '#ff6b35',
                    params: [
                        { key: 'target_thickness', label: '目标厚度', unit: 'μm', precision: 3 },
                        { key: 'contrast_ratio', label: '对比度比例', unit: '%', precision: 1 },
                        { key: 'optimization_method', label: '优化方法', unit: '', precision: 0, isText: true }
                    ]
                }
            ];
            
            // 生成参数卡片HTML
            let cardsHTML = '';
            
            paramGroups.forEach(group => {
                cardsHTML += `
                    <div style="background: white; border-radius: 12px; padding: 20px; border: 1px solid #e9ecef; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div style="margin-bottom: 15px;">
                            <h5 style="margin: 0; color: ${group.color}; font-weight: 600;">${group.title}</h5>
                        </div>
                        <div style="space-y: 8px;">
                `;
                
                group.params.forEach(param => {
                    const value = predictedParams[param.key];
                    let displayValue = '';
                    
                    if (param.isText) {
                        displayValue = value || '--';
                    } else if (value !== undefined && value !== null) {
                        if (param.precision > 0) {
                            displayValue = parseFloat(value).toFixed(param.precision);
                        } else {
                            displayValue = Math.round(value);
                        }
                        if (param.unit) {
                            displayValue += ` ${param.unit}`;
                        }
                    } else {
                        displayValue = '--';
                    }
                    
                    cardsHTML += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f8f9fa;">
                            <span style="color: #666; font-size: 14px;">${param.label}:</span>
                            <span style="font-weight: 600; color: #333; font-size: 14px;">${displayValue}</span>
                        </div>
                    `;
                });
                
                cardsHTML += `
                        </div>
                    </div>
                `;
            });
            
            // 添加目标信息卡片
            cardsHTML += `
                <div style="background: linear-gradient(135deg, #20c997 0%, #17a2b8 100%); border-radius: 12px; padding: 20px; color: white; box-shadow: 0 4px 8px rgba(0,0,0,0.15);">
                    <div style="margin-bottom: 15px;">
                        <h5 style="margin: 0; color: white; font-weight: 600;">预测目标</h5>
                    </div>
                    <div style="space-y: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                            <span style="color: rgba(255,255,255,0.9); font-size: 14px;">目标位置:</span>
                            <span style="font-weight: 600; font-size: 14px;">(${targetInfo.x}, ${targetInfo.y})</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                            <span style="color: rgba(255,255,255,0.9); font-size: 14px;">目标厚度:</span>
                            <span style="font-weight: 600; font-size: 14px;">${targetInfo.thickness.toFixed(3)} μm</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                            <span style="color: rgba(255,255,255,0.9); font-size: 14px;">预测方法:</span>
                            <span style="font-weight: 600; font-size: 14px;">机器学习算法</span>
                        </div>
                    </div>
                </div>
            `;
            
            // 更新界面
            paramsGrid.innerHTML = cardsHTML;
            
            // 平滑滚动到结果区域
            setTimeout(() => {
                predictionSection.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
            }, 100);
            
            console.log('✅ 完整参数预测结果已显示');
        }

        // 显示参数预测输入弹窗
        function showPredictionInputModal() {
            const modal = document.getElementById('prediction-input-modal');
            if (modal) {
                modal.style.display = 'block';
                // 初始化模型状态检查
                updateModelInfo(document.getElementById('prediction-model-select').value);
            }
        }
        
        // 更新模型状态信息
        function updateModelInfo(modelType) {
            const statusInfo = document.getElementById('model-status-info');
            const statusText = document.getElementById('model-status-text');
            
            // 发送请求检查模型状态
            fetch('/api/validation_stats')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const modelStatus = data.data.model_files_status;
                        const availableModels = data.data.available_models;
                        
                        if (modelStatus && modelStatus[modelType]) {
                            statusText.textContent = '✅ 模型已训练，可用于预测';
                            statusText.style.color = '#28a745';
                            statusInfo.style.background = '#d4edda';
                            statusInfo.style.border = '1px solid #c3e6cb';
                        } else {
                            statusText.textContent = '❌ 模型未训练，请先训练该模型';
                            statusText.style.color = '#dc3545';
                            statusInfo.style.background = '#f8d7da';
                            statusInfo.style.border = '1px solid #f5c6cb';
                        }
                        
                        // 更新可用模型选项
                        updateModelOptions(availableModels);
                    }
                })
                .catch(error => {
                    console.error('检查模型状态失败:', error);
                    statusText.textContent = '⚠️ 无法检查模型状态';
                    statusText.style.color = '#ffc107';
                    statusInfo.style.background = '#fff3cd';
                    statusInfo.style.border = '1px solid #ffeaa7';
                });
        }
        
        // 更新模型选项可用性
        function updateModelOptions(availableModels) {
            const select = document.getElementById('prediction-model-select');
            const options = select.querySelectorAll('option');
            
            options.forEach(option => {
                const modelType = option.value;
                if (availableModels.includes(modelType)) {
                    option.disabled = false;
                    option.style.color = '#333';
                } else {
                    option.disabled = true;
                    option.style.color = '#999';
                    option.textContent = option.textContent.replace(' (未训练)', '') + ' (未训练)';
                }
            });
            
            // 如果当前选择的模型不可用，选择第一个可用的模型
            if (availableModels.length > 0 && !availableModels.includes(select.value)) {
                select.value = availableModels[0];
                updateModelInfo(availableModels[0]);
            }
        }

        // 关闭参数预测输入弹窗
        function closePredictionInputModal() {
            const modal = document.getElementById('prediction-input-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // 开始预测
        function startPrediction() {
            // 获取用户输入
            const targetX = parseFloat(document.getElementById('target-x').value) || 0;
            const targetThickness = parseFloat(document.getElementById('target-thickness').value) || 1.0;
            const selectedModel = document.getElementById('prediction-model-select').value;
            
            // 根据当前厚度曲线计算对应的Y值
            let targetY = 0;
            
            // 尝试访问validation.js中的全局变量
            const globalThicknessData = window.thicknessData || currentThicknessData;
            
            if (typeof calculateThicknessAtPosition === 'function' && globalThicknessData) {
                // 使用validation.js中的函数计算当前X位置的厚度值作为Y
                targetY = calculateThicknessAtPosition(targetX, 0) || targetThickness;
                console.log(`根据X=${targetX}计算得到Y=${targetY}，数据来源:`, globalThicknessData ? '当前厚度数据' : '默认值');
            } else {
                // 如果没有当前数据，使用目标厚度作为Y值
                targetY = targetThickness;
                console.log(`无法获取厚度数据，使用目标厚度作为Y值: ${targetY}`);
            }

            // 验证输入
            if (targetThickness <= 0) {
                alert('期待厚度必须大于0');
                return;
            }

            // 关闭弹窗
            closePredictionInputModal();
            
            // 隐藏其他结果区域，避免重叠显示
            const sectionsToHide = [
                'optimization-result-section', 
                'training-curves-section',
                'experience-analysis',
                'validation-data-selector'
            ];
            
            sectionsToHide.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.style.display = 'none';
                }
            });

            // 获取预测按钮并显示加载状态
            const predictBtn = document.getElementById('predict-parameters');
            if (predictBtn) {
                predictBtn.textContent = '预测中...';
                predictBtn.disabled = true;
            }

            // 调用预测API
            fetch('/api/predict_parameters', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    x: targetX,
                    y: targetY,
                    target_thickness: targetThickness,
                    model_type: selectedModel
                })
            })
            .then(response => response.json())
            .then(data => {
                // 恢复按钮状态
                if (predictBtn) {
                    predictBtn.textContent = '参数预测';
                    predictBtn.disabled = false;
                }
                
                if (data.success) {
                    console.log('参数预测成功，收到数据:', data);
                    
                    // 从预测结果中提取完整参数
                    const predictedParams = data.data?.predicted_parameters || {};
                    const targetInfo = {
                        x: data.data?.target_position?.x || targetX,
                        y: data.data?.target_position?.y || targetY,
                        thickness: data.data?.target_thickness || targetThickness
                    };
                    
                    console.log('预测的完整参数:', predictedParams);
                    
                    // 额外：在顶部简要结果区域也同步显示，避免用户误以为没有结果
                    try {
                        const exposureTime = Number(predictedParams.t_exp ?? data.data?.ml_predictions?.t_exp ?? 0);
                        const strategyName = (predictedParams.optimization_method || '机器学习预测');
                        const thicknessValue = Number(predictedParams.target_thickness ?? targetInfo.thickness ?? 0);
                        if (!Number.isNaN(exposureTime) && !Number.isNaN(thicknessValue)) {
                            showPredictionResult(exposureTime.toFixed(2), strategyName, thicknessValue.toFixed(3));
                        }
                    } catch (e) {
                        console.warn('简要结果显示失败（可忽略）:', e);
                    }

                    // 显示完整的参数预测结果
                    showCompletePredictionResult(predictedParams, targetInfo);
                } else {
                    const errorMsg = data.message || data.error || '未知错误';
                    alert('预测失败：' + errorMsg);
                    console.error('预测失败:', data);
                }
            })
            .catch(error => {
                // 恢复按钮状态
                if (predictBtn) {
                    predictBtn.textContent = '参数预测';
                    predictBtn.disabled = false;
                }
                
                console.error('预测API调用失败:', error);
                alert('网络错误，请检查连接后重试');
            });
        }
        // ================================
        // 验证数据选择器相关函数
        // ================================
        
        function showValidationDataSelector() {
            console.log('显示验证数据选择器');
            
            // 隐藏其他区域
            const optimizationResult = document.getElementById('optimization-result-section');
            if (optimizationResult) optimizationResult.style.display = 'none';
            
            // 显示选择器
            const selector = document.getElementById('validation-data-selector');
            if (selector) {
                selector.style.display = 'block';
                // 加载验证数据
                loadValidationDataForOptimization();
                // 绑定事件
                bindValidationSelectorEvents();
            }
        }
        
        function loadValidationDataForOptimization() {
            const container = document.getElementById('validation-records-container');
            if (!container) return;
            
            container.innerHTML = '<div class="loading-message">正在加载验证数据...</div>';
            
            fetch('/api/get_validation_data_for_optimization')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data.records) {
                        validationRecords = data.data.records;
                        renderValidationRecords(validationRecords);
                    } else {
                        container.innerHTML = '<div class="loading-message">无法加载验证数据: ' + (data.message || '未知错误') + '</div>';
                    }
                })
                .catch(error => {
                    console.error('加载验证数据失败:', error);
                    container.innerHTML = '<div class="loading-message">网络错误，请重试</div>';
                });
        }
        
        function renderValidationRecords(records) {
            const container = document.getElementById('validation-records-container');
            if (!container || !records || records.length === 0) {
                container.innerHTML = '<div class="loading-message">没有找到验证数据记录</div>';
                return;
            }
            
            const recordsHtml = records.map((record, index) => {
                // 计算偏差可视化参数
                const maxDeviation = 0.3; // 最大偏差用于归一化
                const normalizedDeviation = Math.max(-1, Math.min(1, record.deviation / maxDeviation));
                const barWidthPercent = Math.abs(normalizedDeviation) * 40 + 10; // 10-50% 宽度
                
                // 修正逻辑：条只在对应方向显示
                let barLeft, barWidth;
                if (record.deviation > 0) {
                    // 正偏差（预测偏薄）：从中心线向右延伸
                    barLeft = 50; // 从中心开始
                    barWidth = barWidthPercent; // 向右延伸的宽度
                } else {
                    // 负偏差（预测偏厚）：从中心线向左延伸
                    barLeft = 50 - barWidthPercent; // 向左延伸
                    barWidth = barWidthPercent; // 宽度
                }
                
                // 根据偏差设置颜色类
                let deviationClass = 'deviation-neutral';
                if (Math.abs(record.deviation) < 0.05) {
                    deviationClass = 'deviation-accurate';
                } else if (record.deviation > 0.1) {
                    deviationClass = 'deviation-under';
                } else if (record.deviation < -0.1) {
                    deviationClass = 'deviation-over';
                } else if (record.deviation > 0) {
                    deviationClass = 'deviation-slightly-under';
                } else {
                    deviationClass = 'deviation-slightly-over';
                }
                
                // 格式化时间戳
                const timestamp = record.timestamp ? new Date(record.timestamp).toLocaleString('zh-CN', {
                    month: 'numeric',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : '--';
                
                return `
                    <div class="validation-record" data-index="${record.index}" draggable="true">
                        <div class="record-drag-handle">⋮⋮</div>
                        <input type="checkbox" class="record-checkbox" id="record-${record.index}">
                        <div class="record-info">
                            <div class="record-header">
                                <div class="record-position">
                                    位置: (${record.position_x.toFixed(0)}, ${record.position_y.toFixed(2)})
                                </div>
                                <div class="record-timestamp">${timestamp}</div>
                            </div>
                            <div class="record-values">
                                <span class="record-simulated">模拟: ${record.simulated_value}</span>
                                <span class="record-actual">实际: ${record.actual_value}</span>
                            </div>
                            <div class="record-deviation-visual">
                                <div class="deviation-bar-container">
                                    <div class="deviation-center-line"></div>
                                    <div class="deviation-bar ${deviationClass}" 
                                         style="left: ${barLeft}%; width: ${barWidth}%; transform: translateY(-50%);">
                                        <span class="deviation-text">${record.deviation > 0 ? '+' : ''}${record.deviation} (${record.deviation_percentage > 0 ? '+' : ''}${record.deviation_percentage}%)</span>
                                    </div>
                                </div>
                            </div>
                            <div class="record-analysis">
                                ${record.analysis.message}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = recordsHtml;
            
            // 绑定拖拽事件
            bindDragEvents();
            
            // 绑定记录点击事件
            container.querySelectorAll('.validation-record').forEach(record => {
                record.addEventListener('click', function(e) {
                    if (e.target.type !== 'checkbox' && !e.target.classList.contains('record-drag-handle')) {
                        const checkbox = this.querySelector('.record-checkbox');
                        checkbox.checked = !checkbox.checked;
                        updateRecordSelection();
                    }
                });
            });
            
            container.querySelectorAll('.record-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateRecordSelection);
            });
        }
        
        // 拖拽排序功能
        function bindDragEvents() {
            const container = document.getElementById('validation-records-container');
            let draggedElement = null;
            let placeholder = null;
            
            container.querySelectorAll('.validation-record').forEach(record => {
                record.addEventListener('dragstart', function(e) {
                    draggedElement = this;
                    this.classList.add('dragging');
                    
                    // 创建占位符
                    placeholder = document.createElement('div');
                    placeholder.className = 'record-placeholder';
                    placeholder.innerHTML = '<div class="placeholder-text">在此放置</div>';
                    
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/html', this.outerHTML);
                });
                
                record.addEventListener('dragend', function(e) {
                    this.classList.remove('dragging');
                    if (placeholder && placeholder.parentNode) {
                        placeholder.parentNode.removeChild(placeholder);
                    }
                    draggedElement = null;
                    placeholder = null;
                });
                
                record.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    if (this === draggedElement) return;
                    
                    const afterElement = getDragAfterElement(container, e.clientY);
                    if (afterElement == null) {
                        container.appendChild(placeholder);
                    } else {
                        container.insertBefore(placeholder, afterElement);
                    }
                });
                
                record.addEventListener('drop', function(e) {
                    e.preventDefault();
                    if (this === draggedElement) return;
                    
                    if (placeholder && placeholder.parentNode) {
                        placeholder.parentNode.insertBefore(draggedElement, placeholder);
                        placeholder.parentNode.removeChild(placeholder);
                    }
                });
            });
            
            // 容器的拖拽事件
            container.addEventListener('dragover', function(e) {
                e.preventDefault();
                const afterElement = getDragAfterElement(container, e.clientY);
                if (afterElement == null) {
                    container.appendChild(placeholder);
                } else {
                    container.insertBefore(placeholder, afterElement);
                }
            });
            
            container.addEventListener('drop', function(e) {
                e.preventDefault();
                if (placeholder && placeholder.parentNode && draggedElement) {
                    placeholder.parentNode.insertBefore(draggedElement, placeholder);
                    placeholder.parentNode.removeChild(placeholder);
                }
            });
        }
        
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.validation-record:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        
        function bindValidationSelectorEvents() {
            // 全选按钮
            const selectAllBtn = document.getElementById('select-all-records');
            if (selectAllBtn) {
                selectAllBtn.onclick = function() {
                    document.querySelectorAll('.record-checkbox').forEach(cb => cb.checked = true);
                    updateRecordSelection();
                };
            }
            
            // 清空按钮
            const clearAllBtn = document.getElementById('clear-all-records');
            if (clearAllBtn) {
                clearAllBtn.onclick = function() {
                    document.querySelectorAll('.record-checkbox').forEach(cb => cb.checked = false);
                    updateRecordSelection();
                };
            }
            
            // 优化按钮
            const quickOptimizeBtn = document.getElementById('quick-optimize-btn');
            const customOptimizeBtn = document.getElementById('custom-optimize-btn');
            
            if (quickOptimizeBtn) {
                quickOptimizeBtn.onclick = () => {
                    // 隐藏自定义设置
                    document.getElementById('custom-optimization-settings').style.display = 'none';
                    performExperienceBasedOptimization('quick');
                };
            }
            
            if (customOptimizeBtn) {
                customOptimizeBtn.onclick = () => {
                    // 显示自定义设置
                    const customSettings = document.getElementById('custom-optimization-settings');
                    if (customSettings.style.display === 'none') {
                        customSettings.style.display = 'block';
                        customOptimizeBtn.textContent = '执行自定义优化';
                    } else {
                        performExperienceBasedOptimization('custom');
                    }
                };
            }
            
            // 取消按钮
            const cancelBtn = document.getElementById('cancel-optimization');
            if (cancelBtn) {
                cancelBtn.onclick = function() {
                    document.getElementById('validation-data-selector').style.display = 'none';
                    // 重置自定义设置显示状态
                    document.getElementById('custom-optimization-settings').style.display = 'none';
                    const customBtn = document.getElementById('custom-optimize-btn');
                    if (customBtn) customBtn.textContent = '自定义优化 (多种策略)';
                };
            }
        }
        
        function updateRecordSelection() {
            const checkboxes = document.querySelectorAll('.record-checkbox');
            selectedRecordIndices = [];
            
            checkboxes.forEach((checkbox, index) => {
                const recordElement = checkbox.closest('.validation-record');
                const recordIndex = parseInt(recordElement.dataset.index);
                
                if (checkbox.checked) {
                    selectedRecordIndices.push(recordIndex);
                    recordElement.classList.add('selected');
                } else {
                    recordElement.classList.remove('selected');
                }
            });
            
            // 更新选择计数
            const countElement = document.getElementById('selected-records-count');
            if (countElement) {
                countElement.textContent = selectedRecordIndices.length;
            }
            
            // 启用/禁用优化按钮
            const quickBtn = document.getElementById('quick-optimize-btn');
            const customBtn = document.getElementById('custom-optimize-btn');
            const hasSelection = selectedRecordIndices.length > 0;
            
            if (quickBtn) quickBtn.disabled = !hasSelection;
            if (customBtn) customBtn.disabled = !hasSelection;
            
            console.log('已选择记录:', selectedRecordIndices);
        }
        
        function performExperienceBasedOptimization(type) {
            if (selectedRecordIndices.length === 0) {
                alert('请先选择至少一条验证记录');
                return;
            }
            
            // 隐藏所有结果区域，避免重叠显示
            const sectionsToHide = [
                'complete-prediction-section',
                'optimization-result-section', 
                'training-curves-section',
                'experience-analysis'
            ];
            
            sectionsToHide.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.style.display = 'none';
                }
            });
            
            // 获取目标参数
            const targetThickness = parseFloat(document.getElementById('target-thickness-input').value) || 1.0;
            const targetX = parseFloat(document.getElementById('target-position-x').value) || 0;
            const targetY = parseFloat(document.getElementById('target-position-y').value) || 0;
            
            // 获取自定义参数
            let customParams = {};
            if (type === 'custom') {
                customParams = {
                    sensitivity: parseFloat(document.getElementById('custom-sensitivity').value) || 2.0,
                    confidence_threshold: parseFloat(document.getElementById('custom-confidence-threshold').value) || 0.5,
                    strategy_count: parseInt(document.getElementById('custom-strategy-count').value) || 3
                };
            }
            
            console.log(`开始${type}优化，基于${selectedRecordIndices.length}条记录`, customParams);
            
            // 禁用按钮并显示加载状态
            const quickBtn = document.getElementById('quick-optimize-btn');
            const customBtn = document.getElementById('custom-optimize-btn');
            const originalQuickText = quickBtn ? quickBtn.textContent : '';
            const originalCustomText = customBtn ? customBtn.textContent : '';
            
            if (quickBtn) {
                quickBtn.disabled = true;
                quickBtn.textContent = '优化中...';
            }
            if (customBtn) {
                customBtn.disabled = true;
                customBtn.textContent = '优化中...';
            }
            
            // 调用后端API
            const requestData = {
                target_x: targetX,
                target_y: targetY,
                target_thickness: targetThickness,
                selected_records: selectedRecordIndices,
                optimization_type: type,
                ...customParams
            };
            
            fetch('/api/smart_optimize_exposure', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                // 恢复按钮状态
                if (quickBtn) {
                    quickBtn.disabled = false;
                    quickBtn.textContent = originalQuickText;
                }
                if (customBtn) {
                    customBtn.disabled = false;
                    customBtn.textContent = originalCustomText;
                }
                
                if (data.success) {
                    const options = data.data?.exposure_options || [];
                    console.log('收到优化结果:', options);
                    
                    if (options.length > 0) {
                        // 选择合适的结果显示
                        // 优先顺序：最优策略 > 最高置信度 > 平衡策略 > 第一项
                        let selectedOption = options.find(opt => opt.type === 'optimal');
                        if (!selectedOption) {
                            const bestByConfidence = options.reduce((best, o) => {
                                const c = (typeof o.confidence === 'number') ? o.confidence : -1;
                                if (best == null) return { item: o, score: c };
                                return c > best.score ? { item: o, score: c } : best;
                            }, null);
                            if (bestByConfidence && bestByConfidence.score >= 0) {
                                selectedOption = bestByConfidence.item;
                            }
                        }
                        if (!selectedOption) {
                            selectedOption = options.find(opt => opt.type === 'balanced') || options[0];
                        }
                        
                        showExperienceBasedOptimizationResult(selectedOption, selectedRecordIndices.length, options);
                        
                        // 隐藏选择器
                        document.getElementById('validation-data-selector').style.display = 'none';
                        
                        // 重置自定义设置
                        document.getElementById('custom-optimization-settings').style.display = 'none';
                        const customBtn = document.getElementById('custom-optimize-btn');
                        if (customBtn) customBtn.textContent = '自定义优化 (多种策略)';
                    } else {
                        alert('优化成功但未返回结果');
                    }
                } else {
                    alert('优化失败：' + (data.message || '未知错误'));
                }
            })
            .catch(error => {
                // 恢复按钮状态
                if (quickBtn) {
                    quickBtn.disabled = false;
                    quickBtn.textContent = originalQuickText;
                }
                if (customBtn) {
                    customBtn.disabled = false;
                    customBtn.textContent = originalCustomText;
                }
                
                console.error('优化API调用失败:', error);
                alert('网络错误，请检查连接后重试');
            });
        }
        
        function renderExposureTimePills(options) {
            const list = document.getElementById('exposure-time-multi');
            const single = document.getElementById('exposure-time-value');
            if (!list || !single) return;
            list.innerHTML = '';
            if (!options || options.length <= 1) {
                list.style.display = 'none';
                single.style.display = 'inline';
                return;
            }
            // 显示多策略
            list.style.display = 'flex';
            single.style.display = 'none';
            options.forEach((opt, idx) => {
                const pill = document.createElement('span');
                const isHighlight = opt.type === 'optimal' || idx === 1;
                pill.className = 'exposure-time-pill' + (isHighlight ? ' highlight' : '');
                pill.textContent = (opt.exposure_time ?? opt.t_exp ?? 0) + 's';
                
                // 添加策略信息到tooltip
                const strategyLabel = opt.label || opt.strategy || '未知策略';
                const strategyType = opt.type || '标准';
                const confidence = opt.confidence ? ` (置信度: ${(opt.confidence * 100).toFixed(1)}%)` : '';
                const tooltipText = `${strategyLabel}${confidence}`;
                
                pill.setAttribute('data-tooltip', tooltipText);
                pill.setAttribute('data-strategy-type', strategyType);
                pill.setAttribute('title', tooltipText); // 备用tooltip
                
                // 添加动画效果
                pill.style.transform = 'scale(0.9)';
                pill.style.opacity = '0';
                setTimeout(() => {
                    pill.style.transform = 'scale(1)';
                    pill.style.opacity = '1';
                }, idx * 100);
                
                list.appendChild(pill);
            });
        }

        function showExperienceBasedOptimizationResult(option, recordCount, allOptions) {
            // 显示结果区域
            const resultSection = document.getElementById('optimization-result-section');
            if (resultSection) {
                resultSection.style.display = 'block';
                
                // 更新基本结果
                document.getElementById('exposure-time-value').textContent = option.exposure_time + 's';
                // 优化策略文案：带上置信度（若有）
                const strategyText = option.confidence != null
                    ? `${option.label}（置信度 ${(Number(option.confidence) * 100).toFixed(1)}%${option.confidence_text ? '·' + option.confidence_text : ''}）`
                    : option.label;
                document.getElementById('strategy-value').textContent = strategyText;
                document.getElementById('thickness-value').textContent = option.predicted_thickness + 'μm';
                // 若提供多策略，渲染胶囊显示
                renderExposureTimePills(allOptions);
                
                // 经验分析报告不再展示
                const analysisSection = document.getElementById('experience-analysis');
                if (analysisSection) {
                    analysisSection.style.display = 'none';
                }
                
                // 滚动到结果区域，但不要滚动到页面底部
                setTimeout(() => {
                    const resultSection = document.getElementById('optimization-result-section');
                    if (resultSection) {
                        // 获取结果区域的位置
                        const resultRect = resultSection.getBoundingClientRect();
                        const resultTop = window.pageYOffset + resultRect.top;
                        const resultBottom = window.pageYOffset + resultRect.bottom;
                        
                        // 获取页脚位置
                        const footer = document.querySelector('.professional-footer');
                        let maxScroll = document.documentElement.scrollHeight - window.innerHeight;
                        
                        if (footer) {
                            const footerRect = footer.getBoundingClientRect();
                            const footerTop = window.pageYOffset + footerRect.top;
                            maxScroll = footerTop - 100; // 页脚上方100px
                        }
                        
                        // 计算滚动目标：让结果区域可见，但不超过页脚
                        let targetScroll = resultBottom - window.innerHeight + 50; // 结果底部留50px边距
                        targetScroll = Math.min(targetScroll, maxScroll); // 不超过页脚限制
                        targetScroll = Math.max(0, targetScroll); // 不小于0
                        
                        window.scrollTo({ top: targetScroll, behavior: 'smooth' });
                    }
                }, 100); // 短延时，确保DOM更新完成
            }
        }

    </script>
</body>
</html>