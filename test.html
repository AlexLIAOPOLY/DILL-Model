<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>单位转换测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            padding: 8px;
            width: 100%;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .preview {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        #result {
            margin-top: 20px;
            padding: 15px;
            background-color: #f0f8ff;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>自定义数据单位转换测试</h1>
        
        <div class="section">
            <h2>自定义数据输入</h2>
            <div class="form-group">
                <label for="data-input">输入数据（格式：每行 "x值 强度值"）</label>
                <textarea id="data-input" rows="10" style="width: 100%">-1.0 0.10
-0.8 0.15
-0.6 0.20
-0.4 0.25
-0.2 0.30
0.0 0.40
0.2 0.30
0.4 0.25
0.6 0.20
0.8 0.15
1.0 0.10</textarea>
            </div>
            
            <div class="form-group">
                <label for="unit-select">数据单位</label>
                <select id="unit-select">
                    <option value="mm">毫米 (mm)</option>
                    <option value="um" selected>微米 (μm)</option>
                    <option value="nm">纳米 (nm)</option>
                    <option value="custom">自定义</option>
                </select>
            </div>
            
            <div class="form-group" id="custom-scale-container" style="display: none;">
                <label for="custom-scale-factor">自定义比例因子（相对于毫米）</label>
                <input type="number" id="custom-scale-factor" value="0.001" min="0.000001" step="0.000001">
            </div>
            
            <button id="preview-btn">预览数据</button>
            
            <div class="preview" id="data-preview" style="display: none;">
                <h3>数据预览</h3>
                <div id="preview-content"></div>
                <div id="plot-container" style="width: 100%; height: 300px;"></div>
            </div>
        </div>
        
        <div class="section">
            <h2>单位转换结果</h2>
            <button id="convert-btn">执行单位转换</button>
            <div id="result"></div>
        </div>
    </div>
    
    <!-- 加载Plotly.js库用于绘图 -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    
    <script>
        // 全局变量
        let customData = {
            x: [],
            intensity: [],
            loaded: false,
            x_unit: 'um',
            unit_scale: 0.001, // 微米到毫米的转换
            auto_detected: false
        };
        
        // DOM加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化单位选择
            const unitSelect = document.getElementById('unit-select');
            const customScaleContainer = document.getElementById('custom-scale-container');
            const customScaleFactor = document.getElementById('custom-scale-factor');
            
            // 单位选择变化时的处理
            unitSelect.addEventListener('change', function() {
                const selectedUnit = this.value;
                
                // 显示或隐藏自定义比例输入框
                if (selectedUnit === 'custom') {
                    customScaleContainer.style.display = 'block';
                } else {
                    customScaleContainer.style.display = 'none';
                    
                    // 设置预定义单位的比例
                    let scaleFactor = 1.0;
                    switch (selectedUnit) {
                        case 'nm':
                            scaleFactor = 0.000001; // 纳米到毫米
                            break;
                        case 'um':
                            scaleFactor = 0.001; // 微米到毫米
                            break;
                        case 'mm':
                            scaleFactor = 1.0; // 毫米
                            break;
                        default:
                            scaleFactor = 1.0;
                    }
                    
                    customData.unit_scale = scaleFactor;
                    customData.x_unit = selectedUnit === 'um' ? 'μm' : selectedUnit;
                }
            });
            
            // 自定义比例因子变化时的处理
            customScaleFactor.addEventListener('input', function() {
                const value = parseFloat(this.value);
                if (!isNaN(value) && value > 0) {
                    customData.unit_scale = value;
                    customData.x_unit = 'custom';
                }
            });
            
            // 预览按钮点击事件
            document.getElementById('preview-btn').addEventListener('click', function() {
                parseInputData();
                previewData();
            });
            
            // 转换按钮点击事件
            document.getElementById('convert-btn').addEventListener('click', function() {
                convertAndDisplay();
            });
        });
        
        // 解析输入数据
        function parseInputData() {
            const dataInput = document.getElementById('data-input').value;
            const lines = dataInput.trim().split('\n');
            
            customData.x = [];
            customData.intensity = [];
            
            for (const line of lines) {
                const parts = line.trim().split(/\s+/);
                if (parts.length >= 2) {
                    const x = parseFloat(parts[0]);
                    const intensity = parseFloat(parts[1]);
                    
                    if (!isNaN(x) && !isNaN(intensity)) {
                        customData.x.push(x);
                        customData.intensity.push(intensity);
                    }
                }
            }
            
            customData.loaded = customData.x.length > 0;
        }
        
        // 预览数据
        function previewData() {
            if (!customData.loaded) {
                alert('请先输入有效的数据');
                return;
            }
            
            const dataPreview = document.getElementById('data-preview');
            const previewContent = document.getElementById('preview-content');
            const plotContainer = document.getElementById('plot-container');
            
            dataPreview.style.display = 'block';
            
            // 显示数据统计
            const xMin = Math.min(...customData.x);
            const xMax = Math.max(...customData.x);
            const intensityMin = Math.min(...customData.intensity);
            const intensityMax = Math.max(...customData.intensity);
            
            // 显示单位
            const unitDisplay = customData.x_unit === 'um' ? 'μm' : customData.x_unit;
            
            previewContent.innerHTML = `
                <p><strong>数据点数:</strong> ${customData.x.length}</p>
                <p><strong>X范围:</strong> ${xMin.toFixed(3)} 到 ${xMax.toFixed(3)} ${unitDisplay}</p>
                <p><strong>强度范围:</strong> ${intensityMin.toFixed(6)} 到 ${intensityMax.toFixed(6)}</p>
                <p><strong>单位转换比例:</strong> ×${customData.unit_scale}</p>
            `;
            
            // 绘制图表
            const trace = {
                x: customData.x,
                y: customData.intensity,
                type: 'scatter',
                mode: 'lines+markers',
                name: '光强分布',
                line: {
                    color: 'rgb(31, 119, 180)',
                    width: 2
                },
                marker: {
                    color: 'rgb(31, 119, 180)',
                    size: 6
                }
            };
            
            const layout = {
                title: '光强分布预览',
                xaxis: {
                    title: `位置 (${unitDisplay})`
                },
                yaxis: {
                    title: '光强'
                }
            };
            
            Plotly.newPlot(plotContainer, [trace], layout);
        }
        
        // 执行单位转换并显示结果
        function convertAndDisplay() {
            if (!customData.loaded) {
                alert('请先输入有效的数据并预览');
                return;
            }
            
            const resultDiv = document.getElementById('result');
            
            // 执行坐标转换
            const convertedX = customData.x.map(x => x * customData.unit_scale);
            
            // 创建结果表格
            let resultHtml = `
                <h3>单位转换结果</h3>
                <p>原始单位: ${customData.x_unit}, 转换比例: ×${customData.unit_scale}</p>
                <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                    <thead>
                        <tr>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">原始坐标 (${customData.x_unit})</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">转换后坐标 (mm)</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">光强值</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // 限制显示的行数，避免过多
            const maxRows = 20;
            const showRows = Math.min(customData.x.length, maxRows);
            
            for (let i = 0; i < showRows; i++) {
                resultHtml += `
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 8px;">${customData.x[i].toFixed(6)}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${convertedX[i].toFixed(6)}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${customData.intensity[i].toFixed(6)}</td>
                    </tr>
                `;
            }
            
            // 如果数据点超过显示限制，添加提示
            if (customData.x.length > maxRows) {
                resultHtml += `
                    <tr>
                        <td colspan="3" style="border: 1px solid #ddd; padding: 8px; text-align: center;">
                            (仅显示前 ${maxRows} 行，共 ${customData.x.length} 行数据)
                        </td>
                    </tr>
                `;
            }
            
            resultHtml += `
                    </tbody>
                </table>
            `;
            
            // 添加转换后的图表
            resultHtml += `<div id="converted-plot" style="width: 100%; height: 300px; margin-top: 20px;"></div>`;
            
            resultDiv.innerHTML = resultHtml;
            
            // 绘制转换后的图表
            const trace = {
                x: convertedX,
                y: customData.intensity,
                type: 'scatter',
                mode: 'lines+markers',
                name: '转换后的光强分布',
                line: {
                    color: 'rgb(214, 39, 40)',
                    width: 2
                },
                marker: {
                    color: 'rgb(214, 39, 40)',
                    size: 6
                }
            };
            
            const layout = {
                title: '单位转换后的光强分布',
                xaxis: {
                    title: '位置 (mm)'
                },
                yaxis: {
                    title: '光强'
                }
            };
            
            Plotly.newPlot('converted-plot', [trace], layout);
        }
    </script>
</body>
</html> 